{% extends "base.html" %}
{% block title %}TicketÃ¼bersicht â€“ AlphaRequest{% endblock %}

{% block head %}
<script>
  window._TICKETS = {{ items_json | safe }};
</script>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('ticketsManager', () => ({

    items: window._TICKETS,
    search: '',
    statusFilter: 'all',
    priorityFilter: 'all',
    selectedTickets: [],

    statuses: ['all','in_progress','in_request','approved','archived','rejected'],
    priorities: ['all','low','medium','high','critical'],

    get filtered() {
      let arr = this.items;

      if (this.statusFilter !== 'all') {
        arr = arr.filter(t => t.status === this.statusFilter);
      }

      if (this.priorityFilter !== 'all') {
        arr = arr.filter(t => t.priority === this.priorityFilter);
      }

      if (this.search.trim()) {
        const q = this.search.toLowerCase();
        arr = arr.filter(t =>
          String(t.id).includes(q) ||
          (t.type || '').toLowerCase().includes(q) ||
          (t.creator || '').toLowerCase().includes(q)
        );
      }

      return arr;
    },

    toggleSelection(id) {
      this.selectedTickets.includes(id)
        ? this.selectedTickets = this.selectedTickets.filter(x => x !== id)
        : this.selectedTickets.push(id);
    },

    statusBadge(s) {
      return {
        in_progress: 'bg-yellow-100 text-yellow-800',
        in_request: 'bg-primary/20 text-primary',
        approved: 'bg-green-100 text-green-800',
        archived: 'bg-gray-200 text-gray-700',
        rejected: 'bg-red-100 text-red-800'
      }[s] || 'bg-gray-200 text-gray-700';
    },

    priorityBadge(p) {
      return {
        low: 'bg-gray-100 text-gray-700',
        medium: 'bg-blue-100 text-blue-800',
        high: 'bg-orange-100 text-orange-800',
        critical: 'bg-red-100 text-red-800'
      }[p] || 'bg-gray-100 text-gray-700';
    },

    open(item) {
      this.$dispatch('open-pruefung', item);
    }

  }));
});
</script>
{% endblock %}

{% block content %}
<div x-data="ticketsManager()" class="space-y-6">

  <!-- HEADER -->
  <div class="bg-gray-50 dark:bg-gray-800 rounded-xl shadow border px-6 py-5">
    <h1 class="text-2xl font-bold">TicketÃ¼bersicht</h1>
    <p class="text-sm text-gray-500 mt-1">
      Alle AuftrÃ¤ge & PrÃ¼fungen im System
    </p>
  </div>

  <!-- FILTER -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow border p-4 flex flex-wrap gap-4 items-center">

    <input x-model="search"
           placeholder="ðŸ” Suche nach ID, Titel, Ersteller"
           class="px-3 py-2 border rounded-md w-full md:w-72">

    <select x-model="statusFilter" class="px-3 py-2 border rounded-md">
      <template x-for="s in statuses">
        <option :value="s" x-text="s === 'all' ? 'Alle Status' : s"></option>
      </template>
    </select>

    <select x-model="priorityFilter" class="px-3 py-2 border rounded-md">
      <template x-for="p in priorities">
        <option :value="p" x-text="p === 'all' ? 'Alle PrioritÃ¤ten' : p"></option>
      </template>
    </select>

  </div>

  <!-- LIST -->
  <div class="space-y-4">
    <template x-for="t in filtered" :key="t.id">
      <div @click="open(t)"
           class="cursor-pointer bg-white dark:bg-gray-800 rounded-xl shadow border p-5
                  transition hover:-translate-y-[2px] hover:shadow-xl">

        <div class="flex justify-between gap-6">

          <!-- LEFT -->
          <div class="min-w-0">
            <div class="font-semibold truncate">
              #<span x-text="t.id"></span> Â· <span x-text="t.type"></span>
            </div>
            <div class="text-sm text-gray-500 mt-1">
              Erstellt am <span x-text="t.date"></span> Â· <span x-text="t.creator"></span>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="flex flex-col items-end gap-2 shrink-0">

            <span class="px-3 py-1 rounded-md text-xs font-semibold"
                  :class="statusBadge(t.status)"
                  x-text="t.status"></span>

            <span class="px-3 py-1 rounded-md text-xs font-semibold"
                  :class="priorityBadge(t.priority)">
              PrioritÃ¤t: <span x-text="t.priority"></span>
            </span>

            <template x-if="t.assignee_group">
              <span class="px-3 py-1 rounded-md text-xs font-semibold bg-primary/10 text-primary">
                Fachabteilung
              </span>
            </template>

          </div>
        </div>
      </div>
    </template>

    <template x-if="filtered.length === 0">
      <div class="text-center text-gray-500 py-10">
        Keine Tickets gefunden.
      </div>
    </template>
  </div>

</div>
{% endblock %}
