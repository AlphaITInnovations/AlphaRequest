{% extends "base.html" %}
{% block title %}Pr√ºfung ‚Äì AlphaRequestManager{% endblock %}
{% block page_title %}Pr√ºfung{% endblock %}

{% block head %}
<script>
  window._TICKETS = {{ items_json | safe }};
</script>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('ticketsManager', () => ({

    /* ================= DATA ================= */
    items: window._TICKETS,
    filter: 'all',
    search: '',
    statuses: ['all','in_request','in_progress', 'archived', 'rejected'],
    selectedTickets: [],

    /* Modal */
    isOpen: false,
    pruefungItem: null,

    /* ================= FILTER ================= */
    get filtered() {
      let arr = this.filter === 'all'
        ? this.items
        : this.items.filter(t => t.status === this.filter);

      if (this.search.trim()) {
        const q = this.search.toLowerCase();
        arr = arr.filter(t =>
          (t.type || '').toLowerCase().includes(q) ||
          String(t.id).includes(q) ||
          (t.creator || '').toLowerCase().includes(q)
        );
      }
      return arr;
    },

    /* ================= SELECTION ================= */
    toggleSelection(id) {
      if (this.selectedTickets.includes(id)) {
        this.selectedTickets = this.selectedTickets.filter(x => x !== id);
      } else {
        this.selectedTickets.push(id);
      }
    },

    toggleSelectAll(e) {
      this.selectedTickets = e.target.checked
        ? this.filtered.map(t => t.id)
        : [];
    },

    isSelected(id) {
      return this.selectedTickets.includes(id);
    },

    /* ================= ACTIONS ================= */
    open(item) {
      this.pruefungItem = item;
      this.isOpen = true;
    },

    close() {
      this.isOpen = false;
      this.pruefungItem = null;
    },

    async deleteOne(id) {
      if (!confirm(`Ticket #${id} wirklich l√∂schen?`)) return;
      await fetch(`/tickets/${id}/delete`, { method: 'POST' });
      location.reload();
    },

    async deleteSelected() {
      if (!this.selectedTickets.length) return;
      if (!confirm(`${this.selectedTickets.length} Ticket(s) wirklich l√∂schen?`)) return;

      await Promise.all(
        this.selectedTickets.map(id =>
          fetch(`/tickets/${id}/delete`, { method: 'POST' })
        )
      );
      location.reload();
    },

    /* ================= UI HELPERS ================= */
    statusBadge(s) {
      return {
        pending: "bg-yellow-100 text-yellow-800",
        approved: "bg-green-100 text-green-800",
        rejected: "bg-red-100 text-red-800",
        in_request: "bg-primary/15 text-primary",
        archived: "bg-gray-200 text-gray-700"
      }[s] || "bg-gray-100 text-gray-700";
    },

    priorityBadge(p) {
      return {
        low: "bg-gray-200 text-gray-700",
        medium: "bg-primary/20 text-primary",
        high: "bg-orange-200 text-orange-900",
        critical: "bg-red-200 text-red-900"
      }[p] || "bg-gray-200 text-gray-700";
    }

  }))
})
</script>
{% endblock %}

{% block content %}
<div x-data="ticketsManager()" class="space-y-6">

<!-- ================= FILTER BAR ================= -->
<div class="flex flex-wrap items-center gap-4">

  <div class="flex gap-2">
    <template x-for="s in statuses">
      <button
        @click="filter=s"
        :class="filter===s
          ? 'bg-primary text-white'
          : 'bg-white border hover:bg-primary/10'"
        class="px-4 py-2 rounded-lg font-medium capitalize">
        <span x-text="s"></span>
      </button>
    </template>
  </div>

  <div class="ml-auto flex gap-2">
    <input
      type="text"
      placeholder="üîç Suchen‚Ä¶"
      x-model="search"
      class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-primary">

    <button @click="search=''"
            class="px-3 py-2 bg-gray-200 rounded-lg">
      Zur√ºcksetzen
    </button>
  </div>
</div>

<!-- ================= BULK ACTIONS ================= -->
<div class="flex justify-end">
  <button
    @click="deleteSelected"
    :disabled="selectedTickets.length===0"
    class="px-4 py-2 bg-red-600 text-white rounded-lg
           disabled:opacity-50 disabled:cursor-not-allowed">
    üóëÔ∏è Ausgew√§hlte l√∂schen (<span x-text="selectedTickets.length"></span>)
  </button>
</div>

<!-- ================= TABLE ================= -->
<div class="bg-white rounded-xl shadow border overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-gray-100">
<tr>
  <th class="p-3"><input type="checkbox" @change="toggleSelectAll"></th>
  <th class="p-3">ID</th>
  <th class="p-3">Titel</th>
  <th class="p-3">Ersteller</th>
  <th class="p-3">Status</th>
  <th class="p-3">Priorit√§t</th>
  <th class="p-3 text-right">Aktionen</th>
</tr>
</thead>

<tbody class="divide-y">
<template x-for="t in filtered" :key="t.id">
<tr class="hover:bg-gray-50">

  <td class="p-3">
    <input type="checkbox"
           :checked="isSelected(t.id)"
           @change="toggleSelection(t.id)">
  </td>

  <td class="p-3 font-mono text-primary" x-text="t.id"></td>

  <td class="p-3">
    <div class="font-medium" x-text="t.type"></div>
    <div class="text-xs text-gray-500" x-text="t.date"></div>
  </td>

  <td class="p-3" x-text="t.creator"></td>

  <td class="p-3">
    <span class="px-2 py-1 rounded text-xs font-semibold"
          :class="statusBadge(t.status)"
          x-text="t.status"></span>
  </td>

  <td class="p-3">
    <span class="px-2 py-1 rounded text-xs font-semibold"
          :class="priorityBadge(t.priority)"
          x-text="t.priority"></span>
  </td>

  <td class="p-3 text-right space-x-2">
    <button
      @click="open(t)"
      class="px-3 py-1.5 rounded bg-primary/10 text-primary hover:bg-primary/20">
      üëÅÔ∏è Ansehen
    </button>

    <button
      @click="deleteOne(t.id)"
      class="px-3 py-1.5 rounded bg-red-100 text-red-700 hover:bg-red-200">
      üóëÔ∏è L√∂schen
    </button>
  </td>

</tr>
</template>

<template x-if="filtered.length===0">
<tr>
  <td colspan="7" class="p-6 text-center text-gray-500">
    Keine Tickets gefunden
  </td>
</tr>
</template>

</tbody>
</table>
</div>

<!-- ================= MODAL ================= -->
<!-- ================= MODAL ================= -->
<div x-show="isOpen" x-cloak class="fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"
       @click="close()"></div>

  <div class="absolute inset-0 flex items-center justify-center p-6">
    <div class="bg-white dark:bg-gray-900
                w-full max-w-5xl
                rounded-2xl shadow-2xl
                border border-gray-200 dark:border-gray-700
                overflow-hidden">

      <!-- ================= HEADER ================= -->
      <div class="px-6 py-4 border-b flex items-start justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">
            Ticket #<span x-text="pruefungItem.id"></span>
          </div>
          <h2 class="text-xl font-semibold mt-1"
              x-text="pruefungItem.type"></h2>
        </div>

        <span
          class="px-3 py-1 rounded-full text-xs font-semibold"
          :class="statusBadge(pruefungItem.status)"
          x-text="pruefungItem.status">
        </span>
      </div>

      <!-- ================= CONTENT ================= -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-0">

        <!-- ================= LEFT ================= -->
        <aside class="lg:col-span-4
                      border-r dark:border-gray-700
                      p-6 space-y-6">

          <!-- META -->
          <div class="space-y-3">
            <div class="text-xs uppercase text-gray-500 tracking-wide">
              √úbersicht
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="rounded-lg border p-3">
                <div class="text-xs text-gray-500">Erstellt am</div>
                <div class="font-medium" x-text="pruefungItem.date"></div>
              </div>

              <div class="rounded-lg border p-3">
                <div class="text-xs text-gray-500">Ersteller</div>
                <div class="font-medium" x-text="pruefungItem.creator"></div>
              </div>
            </div>
          </div>

          <!-- OWNER -->
          <div>
            <div class="text-xs uppercase text-gray-500 tracking-wide mb-2">
              Antragsteller
            </div>

            <div class="rounded-xl border divide-y">
              <div class="p-3">
                <div class="font-medium"
                     x-text="pruefungItem.owner_info.displayName"></div>
                <div class="text-sm text-gray-500"
                     x-text="pruefungItem.owner_info.email"></div>
              </div>

              <div class="p-3 text-sm">
                <div x-text="pruefungItem.owner_info.company"></div>
                <div class="text-gray-500"
                     x-text="pruefungItem.owner_info.position"></div>
              </div>
            </div>
          </div>

          <!-- ASSIGNEE HISTORY -->
            <!-- ASSIGNEE HISTORY -->
            <!-- ASSIGNEE HISTORY -->
<!-- ASSIGNEE HISTORY -->
<div>
  <div class="text-xs uppercase text-gray-500 tracking-wide mb-3">
    Zuweisungsverlauf
  </div>

  <!-- Leer -->
  <template x-if="!pruefungItem.assignee_history || pruefungItem.assignee_history.length === 0">
    <div class="text-sm text-gray-500 italic">
      Kein Verlauf vorhanden
    </div>
  </template>

  <!-- Timeline -->
  <ol
    x-show="pruefungItem.assignee_history && pruefungItem.assignee_history.length > 0"
    class="relative border-l border-gray-300 dark:border-gray-600 pl-6 space-y-6">

    <template x-for="(h, i) in pruefungItem.assignee_history" :key="i">
      <li class="relative">

        <!-- Punkt -->
        <span
          class="absolute -left-[11px] top-1
                 w-5 h-5 rounded-full
                 bg-primary ring-4 ring-white dark:ring-gray-900">
        </span>

        <div class="font-medium text-sm"
             x-text="h.user_name || 'Unbekannt'"></div>

        <div class="text-xs text-gray-500"
             x-text="new Date(h.timestamp).toLocaleString()"></div>

      </li>
    </template>
  </ol>
</div>





        </aside>

        <!-- ================= RIGHT ================= -->
        <section class="lg:col-span-8 p-6 space-y-4
                        max-h-[70vh] overflow-y-auto">

          <div class="text-xs uppercase text-gray-500 tracking-wide">
            Auftragsdetails
          </div>

          <!-- DESCRIPTION (DYNAMISCH) -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <template x-for="(val, key) in pruefungItem.description"
                      :key="key">
              <div class="rounded-xl border p-4">
                <div class="text-xs uppercase text-gray-500 mb-1"
                     x-text="key"></div>
                <div class="font-medium whitespace-pre-wrap"
                     x-text="val || '‚Äì'"></div>
              </div>
            </template>
          </div>

        </section>
      </div>

      <!-- ================= FOOTER ================= -->
      <div class="px-6 py-4 border-t flex justify-end">
        <button @click="close()"
                class="px-5 py-2.5 rounded-md
                       bg-gray-200 hover:bg-gray-300">
          Schlie√üen
        </button>
      </div>

    </div>
  </div>
</div>


</div>
{% endblock %}
