<!-- EDV-Zugang sperren Modal -->
<div x-show="ticketType === 'EDV-Zugang sperren' && showTicketModal" x-cloak>
  <!-- Overlay -->
  <!--<div class="fixed inset-0 bg-black/50 backdrop-blur-md z-40"
     @click.self="showTicketModal = false"></div>-->


  <!-- Modal Container -->
  <div class="fixed inset-0 z-50 overflow-y-auto pointer-events-auto" @keydown.escape.window="showTicketModal = false">
    <div class="min-h-screen flex items-center justify-center px-4 py-10">

      <!-- PANEL -->
      <div class="modal-panel w-full max-w-4xl p-6 relative z-[60]"
           x-data="edvSperrenWizard()"
           x-init="init()">

        <!-- CLOSE BTN -->
        <button @click="showTicketModal = false"
                class="absolute top-4 right-4 text-text hover:text-danger text-2xl focus-ring">Ã—</button>

        <!-- TITLE -->
        <h3 class="text-2xl font-bold mb-6 text-text">ğŸ”’ EDVâ€‘Zugang sperren</h3>

        <!-- FORM -->
        <form x-ref="form" method="post" action="/tickets" @submit.prevent>
          <input type="hidden" name="title" value="EDVâ€‘Zugang sperren">
          <input type="hidden" name="ticket_type" value="EDVâ€‘Zugang sperren">
          <input type="hidden" name="description" x-ref="descField">
          <input type="hidden" name="assignee_id" :value="assignee_id">
          <input type="hidden" name="assignee_name" :value="assigneeName">

          <!-- STEP 1: Basisdaten -->
          <template x-if="step === 1">
            <div class="space-y-6">

              <!-- Benutzername (fÃ¼r Dokumentation) -->
              <section class="card card--pad border-border">
                <label class="text-text text-sm block mb-1">ğŸ‘¤ Benutzername</label>
                <input type="text" class="field w-full" x-model="form.benutzer" name="benutzer">
              </section>

              <!-- Grund -->
              <section class="card card--pad border-border">
                <label class="text-text text-sm block mb-1">ğŸ“ Grund</label>
                <textarea rows="3" class="field w-full" x-model="form.grund" name="grund"></textarea>
              </section>

              <!-- Sperrmodus -->
              <section class="card card--pad border-border space-y-3">
                <p class="text-sm font-medium">â±ï¸ Wann sperren?</p>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" value="sofort" x-model="form.sperrmodus" name="sperrmodus"> Sofort
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" value="datum" x-model="form.sperrmodus" name="sperrmodus"> Ab Datum
                </label>
                <input x-show="form.sperrmodus === 'datum'" type="date" class="field" x-model="form.sperrdatum" name="sperrdatum">
              </section>

              <!-- ELO sperren -->
              <section class="card card--pad border-border space-y-3">
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" x-model="form.eloSperren" name="eloSperren"> ELOâ€‘Benutzer ebenfalls sperren?
                </label>
                <input x-show="form.eloSperren" class="field w-full" placeholder="Position" x-model="form.eloPosition" name="eloPosition">
              </section>

              <!-- Mails weiterleiten -->
              <section class="card card--pad border-border space-y-3">
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" x-model="form.mailsWeiterleiten" name="mailsWeiterleiten"> Mails weiterleiten?
                </label>
                <input x-show="form.mailsWeiterleiten" type="email" class="field w-full" placeholder="Weiterleiten an" x-model="form.weiterleitenAn" name="weiterleitenAn">
              </section>

              <!-- Postfach Vollzugriff -->
              <section class="card card--pad border-border space-y-3">
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" x-model="form.postfachVollzugriff" name="postfachVollzugriff"> Postfachâ€‘Vollzugriff?
                </label>
                <input x-show="form.postfachVollzugriff" type="email" class="field w-full" placeholder="Vollzugriff fÃ¼r" x-model="form.vollzugriffFuer" name="vollzugriffFuer">
              </section>

              <!-- Abwesenheitsnotiz -->
              <section class="card card--pad border-border">
                <label class="inline-flex items-center gap-2 mb-2">
                  <input type="checkbox" x-model="form.abwesenheitAktiv" name="abwesenheitAktiv"> Abwesenheitsnotiz?
                </label>
                <textarea x-show="form.abwesenheitAktiv" class="field w-full" rows="2" x-model="form.abwesenheitText" name="abwesenheitText"></textarea>
              </section>

              <section class="card card--pad border-yellow-300 bg-yellow-50">
                Weiterleitungen & Vollzugriffe bleiben nur 30 Tage aktiv.
              </section>

              <!-- Datenaktion -->
              <section class="card card--pad border-border">
                <label class="text-sm block mb-1">ğŸ—ƒï¸ Datenaktion</label>
                <select class="field w-full" x-model="form.datenAktion" name="datenAktion">
                  <option value="">â€“ bitte wÃ¤hlen â€“</option>
                  <option value="sichern">Sichern</option>
                  <option value="lÃ¶schen">LÃ¶schen</option>
                </select>
              </section>

              <!-- Hardwareâ€‘Handhabung -->
              <section class="card card--pad border-border space-y-3">
                <label class="text-sm block mb-1">ğŸ’» Hardware</label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" x-model="form.hardwareOption" value="anIT" name="hardwareOption"> Wird an IT gesendet
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" x-model="form.hardwareOption" value="bleibt" name="hardwareOption"> Bleibt in Niederlassung
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" x-model="form.hardwareOption" value="weitergabe" name="hardwareOption"> Weitergabe an Mitarbeiter
                </label>

                <input x-show="form.hardwareOption === 'weitergabe'" class="field w-full mt-2" placeholder="Name Mitarbeiter" x-model="form.hardwareWeitergabeName" name="hardwareWeitergabeName">
                <textarea class="field w-full" rows="2" placeholder="Optionale BegrÃ¼ndung" x-model="form.hardwareBegruendung" name="hardwareBegruendung"></textarea>
              </section>

              <!-- STEP 1 Footer -->
              <div class="flex justify-end gap-3 mt-8">
                <button type="button" class="px-4 py-2 bg-card-bg rounded-lg" @click="showTicketModal = false">Abbrechen</button>
                <button type="button" class="px-4 py-2 bg-primary text-white rounded-lg" @click="goStep2()">Weiter â†’</button>
              </div>
            </div>
          </template>

          <!-- STEP 2: ZustÃ¤ndigkeit -->
          <template x-if="step === 2">
            <div class="space-y-8">
              <h2 class="text-xl font-semibold">ZustÃ¤ndigkeit</h2>

              <!-- Assignee -->
              <section class="card card--pad border-border">
                <label class="text-sm font-medium block mb-1">ğŸ‘¤ Verantwortlicher Benutzer</label>
                <select class="field w-full mt-2" x-model="assignee_id" @change="updateAssigneeName($event)" :disabled="group_id" name="assignee_select">
                  <option value="">â€“ Benutzer auswÃ¤hlen â€“</option>
                  <template x-for="u in users" :key="u.id">
                    <option :value="u.id" :data-name="u.displayName" x-text="u.displayName + ' (' + u.mail + ')'"></option>
                  </template>
                </select>
              </section>

              <!-- Gruppe (falls gewÃ¼nscht) -->
              <section class="card card--pad border-border">
                <label class="text-sm font-medium block mb-1">ğŸ‘¥ Verantwortliche Gruppe</label>
                <select class="field w-full mt-2" x-model="group_id" :disabled="assignee_id" name="group_select">
                  <option value="">â€“ Gruppe auswÃ¤hlen â€“</option>
                  <template x-for="g in groups" :key="g.id">
                    <option :value="g.id" x-text="g.name"></option>
                  </template>
                </select>
              </section>

              <!-- Footer -->
              <div class="flex justify-between gap-3 mt-8">
                <button type="button" class="px-4 py-2 bg-card-bg rounded-lg" @click="step = 1">â† ZurÃ¼ck</button>
                <div class="flex gap-3">
                  <button type="button"
                          class="px-4 py-2 bg-primary text-white rounded-lg"
                          :disabled="!canCreate()"
                          :class="!canCreate() ? 'opacity-50 cursor-not-allowed' : ''"
                          @click="submitCreate()">Ticket erstellen</button>

                  <button type="button"
                          class="px-4 py-2 bg-emerald-600 text-white rounded-lg"
                          :disabled="!validate().ok"
                          :class="!validate().ok ? 'opacity-50 cursor-not-allowed' : ''"
                          @click="submitFinish()">AbschlieÃŸen âœ”</button>
                </div>
              </div>
            </div>
          </template>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
function edvSperrenWizard() {
  return {
    step: 1,
    form: {
      benutzer: "", grund: "", sperrmodus: "sofort", sperrdatum: "",
      mailsWeiterleiten: false, weiterleitenAn: "",
      postfachVollzugriff: false, vollzugriffFuer: "",
      abwesenheitAktiv: false, abwesenheitText: "Mitarbeiter ist nicht mehr im Haus",
      datenAktion: "", datenBenutzer: "",
      hardwareOption: "anIT", hardwareWeitergabeName: "", hardwareBegruendung: "",
      eloSperren: false, eloPosition: ""
    },
    users: [],
    groups: [],
    assignee_id: "",
    assigneeName: "",
    group_id: "",

    init() {
      this.$watch("showTicketModal", v => {
        if (v) {
          this.step = 1;
          this.assignee_id = "";
          this.assigneeName = "";
          this.group_id = "";
          this.loadUsers();
          this.loadGroups();
        }
      });
    },

    async loadUsers() {
      const res = await fetch("/api/admin/users");
      const json = await res.json();
      this.users = json.users || [];
    },

    async loadGroups() {
      const res = await fetch("/api/groups");
      const json = await res.json();
      this.groups = json || [];
    },

    updateAssigneeName(event) {
      const selected = event.target.selectedOptions[0];
      this.assigneeName = selected?.dataset.name || "";
    },

    goStep2() {
      this.step = 2;
    },

    validate() {
      // Beispiel: nur Grund + benutzerpflichtig â€” hier anpassen
      if (!this.form.benutzer.trim()) return { ok:false };
      if (!this.form.grund.trim()) return { ok:false };
      return { ok:true };
    },

    canCreate() {
      return this.assignee_id || this.group_id;
    },

    submitCreate() {
      if (!this.canCreate()) {
        alert("Bitte einen Benutzer oder eine Gruppe auswÃ¤hlen.");
        return;
      }
      this.submit(false);
    },

    submitFinish() {
      const v = this.validate();
      if (!v.ok) {
        alert("Bitte alle Pflichtfelder ausfÃ¼llen.");
        return;
      }
      this.submit(true);
    },

    submit(finish) {
      const payload = {
        ticketType: "zugangSperren",
        data: this.form,
        assignee_id: this.assignee_id || null,
        assignee_name: this.assigneeName || null,
        group_id: this.group_id || null,
        finish: finish
      };
      this.$refs.descField.value = JSON.stringify(payload);
      this.$refs.form.submit();
    }
  }
}
</script>
