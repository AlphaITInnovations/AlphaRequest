<!-- modals/detail-niederlassung-schliessen.html (DROP-IN REPLACEMENT) -->
<div x-cloak x-show="$store.modal.is('detail:niederlassung-schliessen')" class="fixed inset-0 z-50">
  <!-- Overlay -->
  <div class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40"
       @click="$store.modal.close()" aria-hidden="true"></div>

  <!-- Wrapper (fix wie Vorlage) -->
  <div class="fixed inset-0 z-50"
       x-trap="$store.modal.is('detail:niederlassung-schliessen')"
       @keydown.escape.window="$store.modal.close()">
    <div class="min-h-screen flex items-center justify-center px-4 py-10">

      <!-- Panel -->
      <div
        class="modal-panel w-full max-w-5xl relative max-h-[85vh] h-auto flex flex-col"
        role="dialog"
        aria-modal="true"
        aria-labelledby="nlCloseDetailTitle"
        x-data="{
          // --- parse + helpers ---
          parseDesc() {
            const o = $store.modal.data || {};
            const d = o.description;
            if (!d) return { ticketType: o.type || 'Niederlassung schlieÃŸen', data: {} };
            try { if (typeof d === 'string') return JSON.parse(d); if (typeof d === 'object') return d; } catch(_) {}
            return { ticketType: o.type || 'Niederlassung schlieÃŸen', data: {} };
          },
          d(){ return $store.modal.data || {}; },
          payload(){ return this.parseDesc(); },
          nl(){ return this.payload().data || {}; },

          fmt(v){ return (v===null||v===undefined||v==='') ? 'â€“' : v; },
          fmtDate(iso){
            if(!iso) return 'â€“';
            const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
            return m ? `${m[3]}.${m[2]}.${m[1]}` : iso;
          },
          chip(on){ return on
            ? 'inline-flex items-center gap-1 px-2 py-0.5 rounded bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-200'
            : 'inline-flex items-center gap-1 px-2 py-0.5 rounded bg-gray-200 text-gray-700 dark:bg-gray-700/50 dark:text-gray-200';
          },
          statusLabel(s){ return ({approved:'Genehmigt', pending:'Ausstehend', rejected:'Abgelehnt'}[s]) || s; },
          statusClass(s){
            const base='inline-block px-2.5 py-0.5 text-xs font-semibold rounded-full align-middle';
            const m={approved:'bg-green-200/80 text-green-900 dark:bg-green-500/70 dark:text-black',
                     pending:'bg-yellow-200/80 text-yellow-900 dark:bg-yellow-500/70 dark:text-black',
                     rejected:'bg-red-200/80 text-red-900 dark:bg-red-600/70 dark:text-white'};
            return `${base} ${m[s] || 'bg-gray-200/80 text-gray-900 dark:bg-gray-600/70 dark:text-white'}`;
          },
          meta(){
            const o = this.d();
            return { id: o.id ?? 'â€“', date: o.date ?? 'â€“', creator: o.creator ?? null, status: o.status ?? 'pending' };
          },

          // --- fields exakt nach deinem JSON ---
          firma(){ return this.nl().firma; },
          niederlassung(){ return this.nl().niederlassung; },
          adresseAktuell(){ return this.nl().aktuell; },
          schliessung(){ return this.nl().schliessung; },
          bemerkung(){ return this.nl().bemerkung; },

          dslKuendigung(){ return this.nl().dslKuendigung === true; },
          rufnummerKuendigung(){ return this.nl().rufnummerKuendigung === true; },

          hardwareMode(){ return this.nl().hardware; }, // 'toIT' | 'stays'
          targetNL(){ return this.nl().targetNL; },

          hardwareChips(){
            const list = [];
            if (this.hardwareMode() === 'toIT') list.push({label:'Hardware an IT', on:true});
            if (this.hardwareMode() === 'stays') list.push({label:'Hardware bleibt in NL', on:true});
            return list;
          }
        }"
      >

        <!-- Header (fix) -->
        <div class="relative p-5 sm:p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="absolute inset-0 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent pointer-events-none"></div>
          <div class="relative flex items-start justify-between gap-4">
            <div>
              <h3 id="nlCloseDetailTitle" class="text-2xl sm:text-3xl font-bold flex items-center gap-2">
                <span class="text-3xl">ğŸ</span>
                <span>Niederlassung schlieÃŸen</span>
              </h3>
              <div class="mt-2 flex flex-wrap items-center gap-2 text-sm">
                <span :class="statusClass(meta().status)" x-text="statusLabel(meta().status)"></span>
                <span class="text-muted">â€¢</span>
                <span class="text-muted">ID: <span class="font-medium text-text" x-text="meta().id"></span></span>
                <span class="text-muted">â€¢</span>
                <span class="text-muted">Datum: <span class="font-medium text-text" x-text="meta().date"></span></span>
                <template x-if="meta().creator">
                  <span class="text-muted">â€¢ Ersteller: <span class="font-medium text-text" x-text="meta().creator"></span></span>
                </template>
              </div>
            </div>
          </div>
        </div>

        <!-- BODY (scrollt) -->
        <div class="flex-1 overflow-auto p-5 sm:p-6 space-y-5">

          <!-- Stammdaten -->
          <section class="card card--pad">
            <h4 class="font-semibold mb-3">ğŸ§¾ Stammdaten</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3 text-sm">
              <div>
                <div class="text-muted">Firma</div>
                <div class="font-medium" x-text="fmt(firma())"></div>
              </div>
              <div>
                <div class="text-muted">Niederlassung</div>
                <div class="font-medium" x-text="fmt(niederlassung())"></div>
              </div>
              <div>
                <div class="text-muted">SchlieÃŸdatum</div>
                <div class="font-medium" x-text="fmtDate(schliessung())"></div>
              </div>
              <div class="sm:col-span-2 xl:col-span-3">
                <div class="text-muted">Adresse (aktuell)</div>
                <div class="font-medium break-words" x-text="fmt(adresseAktuell())"></div>
              </div>
            </div>
          </section>

          <!-- KÃ¼ndigungen -->
          <section class="card card--pad">
            <h4 class="font-semibold mb-3">ğŸ“„ KÃ¼ndigungen</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
              <div :class="chip(dslKuendigung())">DSL kÃ¼ndigen <span x-text="dslKuendigung() ? 'âœ“' : 'â€”'"></span></div>
              <div :class="chip(rufnummerKuendigung())">Rufnummer kÃ¼ndigen <span x-text="rufnummerKuendigung() ? 'âœ“' : 'â€”'"></span></div>
            </div>
          </section>

          <!-- Hardware / Inventar -->
          <section class="card card--pad">
            <h4 class="font-semibold mb-3">ğŸ’» Inventar & Hardware</h4>
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <template x-for="(c, i) in hardwareChips()" :key="i">
                <div :class="chip(c.on)"><span x-text="c.label"></span> <span>âœ“</span></div>
              </template>

              <template x-if="fmt(targetNL()) !== 'â€“'">
                <div class="ml-2 flex items-center gap-2">
                  <span class="text-muted">Ziel-Niederlassung:</span>
                  <span class="font-medium" x-text="targetNL()"></span>
                </div>
              </template>

              <template x-if="hardwareChips().length === 0">
                <span class="text-muted">â€“ keine Angaben â€“</span>
              </template>
            </div>
          </section>

          <!-- Bemerkung -->
          <section class="card card--pad">
            <h4 class="font-semibold mb-2">ğŸ’¬ Bemerkung</h4>
            <p class="text-sm" x-text="fmt(bemerkung())"></p>
          </section>

          <!-- Abschlusskommentar -->
          <section class="card card--pad">
            <h4 class="font-semibold mb-2">ğŸ’¬ Abschlusskommentar</h4>
            <p class="text-sm" x-text="d().comment || 'â€“ kein Kommentar â€“'"></p>
          </section>

        </div>

        <!-- Footer (fix) -->
        <div class="px-5 sm:px-6 py-4 border-t dark:border-gray-700">
          <div class="flex justify-end">
            <button type="button"
                    class="px-5 py-2 bg-primary hover:bg-primaryHover text-white rounded-md"
                    @click="$store.modal.close()">
              SchlieÃŸen
            </button>
          </div>
        </div>

      </div><!-- /Panel -->
    </div>
  </div>
</div>
