{% extends "base.html" %}
{% block title %}Ãœbersicht â€“ AlphaRequest{% endblock %}

{% block head %}
<style>
  :root {
    --primary: #3EAAB8;
    --primary-hover: #2B7D89;
  }

  .nice-scrollbar::-webkit-scrollbar { width:8px; }
  .nice-scrollbar::-webkit-scrollbar-thumb {
      background:rgba(0,0,0,.25);
      border-radius:8px;
  }

  .ticket-accent {
      position:absolute;
      left:0;
      top:12px;
      bottom:12px;
      width:4px;
      border-radius:4px;
      opacity:.7;
      transition:all .25s ease;
  }

  .ticket:hover .ticket-accent {
      width:6px;
      opacity:1;
  }
</style>

<script>
document.addEventListener("alpine:init", () => {
  Alpine.data("dashboardManager", () => ({

    /* ================= DATA ================= */
    orders: {{ orders | tojson }},
    departmentRequests: {{ department_requests | tojson }},
    userName: "{{ user.displayName }}",

    // ğŸ”‘ vom Backend
    allowedTypes: {{ allowed_ticket_types | tojson }},

    ticketTypes: [
      { key: "hardware", icon: "ğŸ“¦", label: "Hardwarebestellung" },
      { key: "zugang-beantragen", icon: "ğŸ”‘", label: "EDV-Zugang beantragen" },
      { key: "zugang-sperren", icon: "ğŸ”’", label: "EDV-Zugang sperren" },
      { key: "niederlassung-anmelden", icon: "ğŸ¢", label: "Niederlassung anmelden" },
      { key: "niederlassung-umzug", icon: "ğŸ”„", label: "Niederlassung Umzug" },
      { key: "niederlassung-schliessen", icon: "âŒ", label: "Niederlassung schlieÃŸen" },
    ],

    /* ================= HELPERS ================= */
    canCreate(key) {
      return this.allowedTypes.includes(key);
    },

    openNew(key) {
      if (!this.canCreate(key)) return;
      window.location.href = `/tickets/new/${key}`;
    },

    openUserTicket(o) {
      window.location.href = `/tickets/edit/${o.type_key}/${o.id}`;
    },

    openGroupTicket(o, groupId) {
      window.location.href =
        `/tickets/group/${o.type_key}/${o.id}?department=${groupId}`;
    },

    statusLabel(s) {
      return {
        in_progress: "In Bearbeitung",
        in_request: "Zu bearbeiten",
        approved: "Erledigt",
        rejected: "Abgelehnt",
      }[s] || s;
    },

    statusBadge(s) {
      return {
        in_progress: "bg-yellow-100 text-yellow-800",
        in_request: "bg-primary/20 text-primary",
        approved: "bg-green-100 text-green-800",
        rejected: "bg-red-100 text-red-800",
      }[s] || "bg-gray-200 text-gray-700";
    },

    priorityLabel(p) {
      return {
        low: "Niedrig",
        medium: "Mittel",
        high: "Hoch",
        critical: "Kritisch",
      }[p] || p;
    },

    priorityIcon(p) {
      return {
        low: "ğŸŸ¢",
        medium: "ğŸŸ¡",
        high: "ğŸŸ ",
        critical: "ğŸ”´",
      }[p] || "âšª";
    },

    statusAccent(s) {
      return {
        in_progress: "bg-yellow-400",
        in_request: "bg-primary",
        approved: "bg-green-500",
        rejected: "bg-red-500",
      }[s] || "bg-gray-400";
    }

  }))
})
</script>
{% endblock %}

{% block content %}
<div x-data="dashboardManager()" class="min-h-[80vh]">

<!-- ================= HEADER ================= -->
<header class="mb-6">
  <div class="bg-gray-50 dark:bg-gray-800 rounded-xl shadow border px-6 py-5">
    <h1 class="text-2xl font-bold">
      Willkommen, <span x-text="userName"></span> ğŸ‘‹
    </h1>
  </div>
</header>

<div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-6">

<!-- ================= SIDEBAR ================= -->
<aside class="bg-gray-50 dark:bg-gray-800 rounded-xl shadow border p-6 lg:sticky lg:top-6 h-fit">
  <h2 class="text-lg font-semibold mb-5 text-primary">
    Neuer Auftrag
  </h2>

  <div class="grid gap-4">

    <template x-for="t in ticketTypes" :key="t.key">
      <template x-if="canCreate(t.key)">
        <button
          @click="openNew(t.key)"
          class="group flex items-center gap-4 px-6 py-4
                 bg-primary text-white rounded-xl
                 transition-all hover:bg-primary-hover
                 hover:shadow-xl hover:-translate-y-[1px]">

          <span class="text-2xl transition group-hover:scale-110"
                x-text="t.icon"></span>

          <span class="font-medium truncate"
                x-text="t.label"></span>
        </button>
      </template>
    </template>

    <!-- EMPTY STATE -->
    <template x-if="ticketTypes.every(t => !canCreate(t.key))">
      <div class="text-sm text-gray-500 italic text-center py-6">
        Du hast aktuell keine Berechtigung, neue Tickets zu erstellen.
      </div>
    </template>

  </div>
</aside>

<!-- ================= CONTENT ================= -->
<section class="space-y-6">

  <!-- ================= DEINE AUFTRÃ„GE ================= -->
  <div class="bg-gray-50 dark:bg-gray-800 rounded-xl shadow border p-5">
    <h2 class="text-xl font-semibold mb-4 text-primary">
      Deine AuftrÃ¤ge
    </h2>

    <ul class="space-y-4 max-h-[480px] overflow-auto nice-scrollbar pr-1">
      <template x-for="o in orders" :key="o.id">
        <li @click="openUserTicket(o)"
            class="ticket relative p-5 rounded-xl border
                   bg-white dark:bg-gray-700 cursor-pointer
                   transition hover:-translate-y-[2px] hover:shadow-xl">

          <div class="ticket-accent" :class="statusAccent(o.status)"></div>

          <div class="flex justify-between gap-4 pl-3">
            <div class="min-w-0">
              <div class="font-semibold truncate" x-text="o.type"></div>
              <div class="text-sm text-gray-500" x-text="o.date"></div>
            </div>

            <div class="flex flex-col items-end gap-1 shrink-0">
              <span class="px-3 py-1 rounded-md text-xs font-semibold"
                    :class="statusBadge(o.status)"
                    x-text="statusLabel(o.status)"></span>

              <span class="px-3 py-1 rounded-md text-xs font-semibold bg-gray-200 text-gray-800">
                <span x-text="priorityIcon(o.priority)"></span>
                <span x-text="priorityLabel(o.priority)"></span>
              </span>
            </div>
          </div>
        </li>
      </template>

      <template x-if="orders.length === 0">
        <li class="text-gray-500 text-sm text-center py-8">
          Keine eigenen AuftrÃ¤ge vorhanden.
        </li>
      </template>
    </ul>
  </div>

<!-- ================= FACHABTEILUNGEN ================= -->
<div class="bg-gray-50 dark:bg-gray-800 rounded-xl shadow border p-5">
  <h2 class="text-xl font-semibold mb-6 text-primary">
    Fachabteilungen Â· Deine Aufgaben
  </h2>

  <!-- Fachabteilung -->
  <template x-for="dept in departmentRequests" :key="dept.group_id">
    <section class="mb-8">

      <!-- Department Header -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold flex items-center gap-2">
          <span>ğŸ¢</span>
          <span x-text="dept.group_name"></span>
        </h3>

        <span class="text-xs px-3 py-1 rounded-full bg-primary/20 text-primary font-semibold">
          <span x-text="dept.tickets.length"></span> offen
        </span>
      </div>

      <!-- Tickets -->
      <ul class="space-y-3">
        <template x-for="ticket in dept.tickets" :key="ticket.id">
          <li
            @click="openGroupTicket(ticket, dept.group_id)"
            class="ticket relative p-5 rounded-xl border
                   bg-white dark:bg-gray-700 cursor-pointer
                   transition hover:-translate-y-[2px] hover:shadow-xl">

            <!-- Accent -->
            <div class="ticket-accent bg-primary"></div>

            <div class="flex justify-between gap-4 pl-3">

              <!-- Ticket Info -->
              <div class="min-w-0">
                <div class="font-semibold truncate" x-text="ticket.title"></div>

                <div class="text-sm text-gray-500 flex gap-3 mt-1">
                  <span x-text="ticket.type_key"></span>
                  <span>â€¢</span>
                  <span x-text="ticket.created_at"></span>
                </div>
              </div>

              <!-- Status -->
              <div class="flex flex-col items-end gap-1 shrink-0">
                <span class="px-3 py-1 rounded-md text-xs font-semibold
                             bg-primary/20 text-primary">
                  ğŸ›  Zu bearbeiten
                </span>
              </div>

            </div>
          </li>
        </template>
      </ul>

    </section>
  </template>

  <!-- Empty State -->
  <template x-if="departmentRequests.length === 0">
    <div class="text-gray-500 text-sm text-center py-8">
      ğŸ‰ Aktuell keine FachabteilungsauftrÃ¤ge fÃ¼r dich.
    </div>
  </template>
</div>




</section>
</div>
</div>
{% endblock %}
