{% extends "base.html" %}
{% block title %}Ãœbersicht â€“ AlphaRequest{% endblock %}

{% block head %}
<script>
document.addEventListener("alpine:init", () => {
  Alpine.data("dashboardManager", () => ({

    /* ================= DATA ================= */
    orders: {{ orders | tojson }},
    departmentRequests: {{ department_requests | tojson }},
    userName: "{{ user.displayName }}",
    allowedTypes: {{ allowed_ticket_types | tojson }},

    ticketTypes: [
      { key: "hardware", icon: "ğŸ“¦", label: "Hardwarebestellung" },
      { key: "zugang-beantragen", icon: "ğŸ”‘", label: "Onboarding Mitarbeiter:innen" },
      { key: "zugang-sperren", icon: "ğŸ”’", label: "Offboarding Mitarbeiter:innen" },
      { key: "niederlassung-anmelden", icon: "ğŸ¢", label: "Niederlassung anmelden" },
      { key: "niederlassung-umzug", icon: "ğŸ”„", label: "Niederlassung umziehen" },
      { key: "niederlassung-schliessen", icon: "âŒ", label: "Niederlassung schlieÃŸen" }
    ],

    /* ================= FILTER ================= */
    filter: {
      search: "",
      status: "all",
      priority: "all",
      department: "all"
    },

    /* ================= HELPERS ================= */
    canCreate(key) {
      return this.allowedTypes.includes(key);
    },

    openNew(key) {
      if (!this.canCreate(key)) return;
      window.location.href = `/tickets/new/${key}`;
    },

    openUserTicket(o) {
      window.location.href = `/tickets/edit/${o.type_key}/${o.id}`;
    },

    openGroupTicket(o, groupId) {
      window.location.href =
        `/tickets/group/${o.type_key}/${o.id}?department=${groupId}`;
    },

    filteredOrders() {
      return this.orders.filter(o => {
        const q = this.filter.search.toLowerCase();
        return (
          (!q || o.type.toLowerCase().includes(q)) &&
          (this.filter.status === "all" || o.status === this.filter.status) &&
          (this.filter.priority === "all" || o.priority === this.filter.priority)
        );
      });
    },

    filteredDepartments() {
      if (this.filter.department === "all") {
        return this.departmentRequests;
      }
      return this.departmentRequests.filter(
        d => d.group_id === this.filter.department
      );
    },

    statusLabel(s) {
      return {
        in_progress: "In Bearbeitung",
        in_request: "Zu bearbeiten",
        approved: "Erledigt",
        rejected: "Abgelehnt"
      }[s] || s;
    },

    statusBadge(s) {
      return {
        in_progress: "bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300",
        in_request: "bg-primary/20 text-primary",
        approved: "bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300",
        rejected: "bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300"
      }[s];
    },

    priorityIcon(p) {
      return {
        low: "ğŸŸ¢",
        medium: "ğŸŸ¡",
        high: "ğŸŸ ",
        critical: "ğŸ”´"
      }[p] || "âšª";
    },

    priorityLabel(p) {
      return {
        low: "Niedrig",
        medium: "Mittel",
        high: "Hoch",
        critical: "Kritisch"
      }[p] || p;
    }

  }));
});
</script>
{% endblock %}

{% block content %}
<div x-data="dashboardManager()" class="min-h-[80vh] space-y-6">

<!-- ================= HEADER ================= -->
<div class="bg-white dark:bg-cardDark rounded-xl shadow-elevated p-6">
  <h1 class="text-2xl font-bold">
    Willkommen, <span x-text="userName"></span> ğŸ‘‹
  </h1>
</div>

<div class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-6">

<!-- ================= SIDEBAR ================= -->
<aside class="bg-white dark:bg-cardDark rounded-xl shadow-elevated p-6 space-y-4 lg:sticky lg:top-6">

  <h2 class="text-lg font-semibold text-primary">
    Neuer Auftrag
  </h2>

  <template x-for="t in ticketTypes" :key="t.key">
    <template x-if="canCreate(t.key)">
      <button
        @click="openNew(t.key)"
        class="w-full flex items-center gap-4 px-5 py-3 rounded-xl
               bg-primary text-white font-medium
               shadow hover:shadow-lg transition"
      >
        <span class="text-xl" x-text="t.icon"></span>
        <span class="truncate" x-text="t.label"></span>
      </button>
    </template>
  </template>

</aside>

<!-- ================= CONTENT ================= -->
<section class="space-y-6">

<!-- ================= DEINE AUFTRÃ„GE ================= -->
<div class="bg-white dark:bg-cardDark rounded-xl shadow-elevated p-6
            dark:shadow-[0_0_0_1px_rgba(62,170,184,0.08)]">

  <h2 class="text-xl font-semibold text-primary mb-4">
    Deine AuftrÃ¤ge
  </h2>

  <!-- FILTER -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-5">
    <input class="field" placeholder="Auftrag suchenâ€¦" x-model="filter.search">
    <select class="field" x-model="filter.status">
      <option value="all">Alle Status</option>
      <option value="in_request">Zu bearbeiten</option>
      <option value="in_progress">In Bearbeitung</option>
      <option value="approved">Erledigt</option>
    </select>
    <select class="field" x-model="filter.priority">
      <option value="all">Alle PrioritÃ¤ten</option>
      <option value="low">Niedrig</option>
      <option value="medium">Mittel</option>
      <option value="high">Hoch</option>
      <option value="critical">Kritisch</option>
    </select>
  </div>

  <ul class="space-y-4 max-h-[460px] overflow-auto pr-1">
    <template x-for="o in filteredOrders()" :key="o.id">
      <li
        @click="openUserTicket(o)"
        class="relative p-5 rounded-xl cursor-pointer
               bg-gray-50 dark:bg-fieldDark
               shadow hover:shadow-xl transition"
      >
        <div class="flex justify-between gap-4">
          <div class="min-w-0">
            <div class="font-semibold truncate" x-text="o.type"></div>
            <div class="text-sm text-muted" x-text="o.date"></div>
          </div>

          <div class="flex flex-col items-end gap-2 shrink-0">
            <span class="px-3 py-1 rounded-md text-xs font-semibold"
                  :class="statusBadge(o.status)"
                  x-text="statusLabel(o.status)"></span>

            <span class="text-xs font-medium">
              <span x-text="priorityIcon(o.priority)"></span>
              <span x-text="priorityLabel(o.priority)"></span>
            </span>
          </div>
        </div>
      </li>
    </template>
  </ul>
</div>

<!-- ================= FACHABTEILUNGEN ================= -->
<div class="bg-white dark:bg-cardDark rounded-xl shadow-elevated p-6
            dark:shadow-[0_0_0_1px_rgba(62,170,184,0.08)]">

  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-semibold text-primary">
      Fachabteilungen Â· Deine Aufgaben
    </h2>

    <select class="field w-56" x-model="filter.department">
      <option value="all">Alle Fachabteilungen</option>
      <template x-for="d in departmentRequests" :key="d.group_id">
        <option :value="d.group_id" x-text="d.group_name"></option>
      </template>
    </select>
  </div>

  <template x-for="dept in filteredDepartments()" :key="dept.group_id">
    <section class="mb-6 rounded-xl p-4
                    bg-gray-50 dark:bg-fieldDark
                    shadow-inner">

      <div class="flex items-center justify-between mb-3"
           x-data="{ open: true }">

        <h3 class="font-semibold flex items-center gap-2 cursor-pointer"
            @click="open = !open">
          ğŸ¢ <span x-text="dept.group_name"></span>
        </h3>

        <span class="text-xs px-3 py-1 rounded-full bg-primary/20 text-primary font-semibold">
          <span x-text="dept.tickets.length"></span>
        </span>
      </div>

      <ul x-show="dept.tickets.length > 0" class="space-y-3">
        <template x-for="t in dept.tickets" :key="t.id">
          <li
            @click="openGroupTicket(t, dept.group_id)"
            class="p-4 rounded-xl cursor-pointer
                   bg-white dark:bg-cardDark
                   shadow hover:shadow-lg transition"
          >
            <div class="font-semibold truncate" x-text="t.title"></div>
            <div class="text-sm text-muted">
              <span x-text="t.type_key"></span> â€¢
              <span x-text="t.created_at"></span>
            </div>
          </li>
        </template>
      </ul>

      <div x-show="dept.tickets.length === 0"
           class="text-sm text-muted italic mt-2">
        Keine offenen Aufgaben fÃ¼r diese Fachabteilung.
      </div>

    </section>
  </template>

</div>

</section>
</div>
</div>
{% endblock %}
