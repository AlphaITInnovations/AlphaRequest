{% extends "base.html" %}
{% block title %}Fachabteilung ‚Äì Auftrag{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-8 space-y-8">

  <!-- ================================================= -->
  <!-- HEADER -->
  <!-- ================================================= -->
  <div class="bg-white dark:bg-gray-800 border rounded-xl shadow p-6">
    <h1 class="text-xl font-semibold">
      {{ ticket.title }}
    </h1>
    <p class="text-sm text-gray-500 mt-1">
      Erstellt am {{ ticket.created_at.strftime("%d.%m.%Y %H:%M") }}
    </p>
  </div>



  <!-- ================================================= -->
  <!-- LAYOUT -->
  <!-- ================================================= -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- ================================================= -->
    <!-- META -->
    <!-- ================================================= -->
    <aside class="bg-white dark:bg-gray-800 border rounded-xl shadow p-6">
      <div class="space-y-4 text-sm">

        <div>
          <div class="font-medium text-gray-500">Ticketstatus</div>
          <div>{{ ticket.status.value }}</div>
        </div>

        <div>
          <div class="font-medium text-gray-500">Priorit√§t</div>
          <div>{{ ticket.priority.value|capitalize }}</div>
        </div>

        <div>
          <div class="font-medium text-gray-500">Antragsteller</div>
          <div>{{ ticket.owner_name }}</div>
        </div>

      </div>
    </aside>

    <!-- ================================================= -->
    <!-- CONTENT -->
    <!-- ================================================= -->
    <section class="lg:col-span-2 space-y-10">

      <!-- ================================================= -->
      <!-- PERSONAL / HR -->
      <!-- ================================================= -->
      <div class="bg-white dark:bg-gray-800 border rounded-xl shadow p-6">
        <h2 class="font-semibold text-lg mb-4">Personal / HR</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div><span class="label">Vorname</span>{{ description.personal.first_name }}</div>
          <div><span class="label">Nachname</span>{{ description.personal.last_name }}</div>
          <div><span class="label">Titel</span>{{ description.personal.title }}</div>
          <div><span class="label">Eintrittsdatum</span>{{ description.personal.start_date }}</div>
          <div><span class="label">Abteilung</span>{{ description.personal.department }}</div>
          <div><span class="label">Kostenstelle</span>{{ description.personal.cost_center }}</div>
          <div><span class="label">Niederlassung</span>{{ description.personal.location }}</div>
          <div><span class="label">Homeoffice</span>{{ description.personal.homeoffice }}</div>
          <div><span class="label">Firma lt. Vertrag</span>{{ description.personal.contract_company }}</div>

          <div class="md:col-span-2">
            <span class="label">Privatadresse</span>
            {{ description.personal.private_address }}
          </div>

          <div>
            <span class="label">Vorgesetzter (HR)</span>
            {{ description.personal.supervisor_hr_name }}
          </div>

          <div>
            <span class="label">Ansprechpartner HR</span>
            {{ description.personal.contact_person_name }}
          </div>

          {% if description.personal.notes %}
          <div class="md:col-span-2">
            <span class="label">Bemerkungen</span>
            {{ description.personal.notes }}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- ================================================= -->
      <!-- ALLGEMEIN -->
      <!-- ================================================= -->
      <div class="bg-white dark:bg-gray-800 border rounded-xl shadow p-6">
        <h2 class="font-semibold text-lg mb-4">Allgemeines Auftreten</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="label">Firma</span>
            {{ description.allgemein.appearance_company }}
          </div>

          <div class="md:col-span-2">
            <span class="label">Adresse</span>
            <pre class="whitespace-pre-wrap">{{ description.allgemein.appearance_address }}</pre>
          </div>
        </div>
      </div>

      <!-- ================================================= -->
      <!-- IT -->
      <!-- ================================================= -->
      <div class="bg-white dark:bg-gray-800 border rounded-xl shadow p-6">
        <h2 class="font-semibold text-lg mb-4">IT / Systemdaten</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div><span class="label">Haupt-Kostenstelle</span>{{ description.it.main_cost_center }}</div>
          <div><span class="label">Arbeitsbeginn</span>{{ description.it.work_start }}</div>
          <div><span class="label">Telefon</span>{{ description.it.signature.phone }}</div>
          <div><span class="label">Mobil</span>{{ description.it.signature.mobile }}</div>
        </div>
      </div>

      <!-- ================================================= -->
      <!-- FUHRPARK -->
      <!-- ================================================= -->
      {% if description.fuhrpark.car == "Ja" %}
      <div class="bg-white dark:bg-gray-800 border rounded-xl shadow p-6">
        <h2 class="font-semibold text-lg mb-4">Fuhrpark</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div><span class="label">Fahrzeugklasse</span>{{ description.fuhrpark.car_class }}</div>
          <div><span class="label">Fahrzeug ab</span>{{ description.fuhrpark.car_from }}</div>
        </div>
      </div>
      {% endif %}

    </section>
  </div>
  <!-- ================================================= -->
  <!-- DEPARTMENT STATUS -->
  <!-- ================================================= -->
  <div class="bg-gray-50 dark:bg-gray-800 border rounded-xl shadow p-6">
    <div class="flex items-center justify-between gap-6">

      <div>
        <h2 class="text-lg font-semibold">
          Fachabteilung:
          <span class="text-primary">{{ department.name }}</span>
        </h2>

        <p class="text-sm mt-1">
          Status:
          {% if department_status == "done" %}
            <span class="text-green-600 font-semibold">‚úî Ausgef√ºhrt</span>
          {% elif department_status == "rejected" %}
            <span class="text-red-600 font-semibold">‚úñ Abgelehnt</span>
          {% else %}
            <span class="text-primary font-semibold">üõ† In Bearbeitung</span>
          {% endif %}
        </p>
      </div>

      {% if can_complete and department_status != "done" %}
        <button
          onclick="completeDepartment()"
          class="px-6 py-2.5 bg-emerald-600 hover:bg-emerald-700
                 text-white rounded-md font-semibold transition">
          ‚úî Ausgef√ºhrt
        </button>

      {% endif %}

    </div>
    <div class="flex justify-end">
    <a href="/dashboard"
       class="px-5 py-2.5 bg-gray-300 dark:bg-gray-600 rounded-md">
      Zur√ºck zum Dashboard
    </a>
  </div>
  </div>
  <!-- ================================================= -->
  <!-- FOOTER -->
  <!-- ================================================= -->


</div>

<style>
.label{
  display:block;
  font-size:.75rem;
  color:#6B7280;
  margin-bottom:.125rem;
}
</style>
    <script>
async function completeDepartment() {
  const confirmed = confirm(
    "Wurde der Auftrag wirklich ausgef√ºhrt?\n\n" +
    "Dieser kann danach nicht mehr bearbeitet werden."
  );

  if (!confirmed) return;

  const response = await fetch(
    "/tickets/{{ ticket.id }}/departments/{{ department_id }}/status",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({
        status: "done"
      })
    }
  );

  if (response.ok) {
    // ‚úÖ zur√ºck zum Dashboard
    window.location.href = "/dashboard";
  } else {
    alert("Fehler beim Abschlie√üen des Auftrags.");
  }
}
</script>

{% endblock %}