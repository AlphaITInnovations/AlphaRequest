{% extends "tickets/_base_ticket.html" %}
{% block title %}Auftrag bearbeiten â€“ {{ ticket.title }}{% endblock %}

{% set form_action = "/tickets/update/" ~ ticket.id %}
{% set alpine_component = "zugangPhase1Form()" %}

{% block hidden_fields %}
<input type="hidden" name="description" x-ref="description">
{% endblock %}

{% block ticket_details %}
  {% include "tickets/partials/_ticket_details.html" %}
{% endblock %}

{% block ticket_fields %}
  {% include "tickets/zugang-beantragen/_form_fields.html" %}
{% endblock %}

{% block ticket_actions %}
  {% include "tickets/partials/_ticket_actions.html" %}
{% endblock %}

{% block extra_js %}

<script>
function zugangPhase1Form() {
  return {
    /* ===============================
       BASE FORM (ðŸ”¥ WICHTIG ðŸ”¥)
    =============================== */
    ...baseForm(),

    /* ===============================
       MODE
    =============================== */
    phase: "edit",
    isCreate: false,
    companies: [],

    /* ===============================
       ASSIGN / WEITERGEBEN
    =============================== */
    openAssignModal: false,
    assigneeMode: "accountable",
    currentAssigneeName: "{{ ticket.assignee_name }}",

    /* ===============================
       DESCRIPTION (PREFILL)
    =============================== */
    p: {
      first_name: "",
      last_name: "",
      title: "",
      private_address: "",
      start_date: "",
      homeoffice: "",
      department: "",
      cost_center: "",
      location: "",
      contract_company: "",
      notes: "",
      supervisor_hr_id: "",
      supervisor_hr_name: "",
      contact_person_id: "",
      contact_person_name: "",
      personal_number: "",
      ...{{ description.personal | default({}) | tojson | safe }}
    },
    a: {
      appearance_company: "",
      appearance_address: "",
      ...{{ description.allgemein | default({}) | tojson | safe }}
    },

    it: {
      main_cost_center: "",
      work_start: "",
      signature: {
        title: "",
        street: "",
        zip: "",
        city: "",
        mobile: "",
        phone: ""
      },
      timebutler: {
        vacation_year: "",
        vacation_start_year: "",
        holiday_rule: "",
        supervisor_id: "",
        supervisor_name: ""
      },
      datev: { user: "" },
      other_systems: "",
      mailboxes: { additional: "", notes: "" },
      additional_cost_centers: "",
      ...{{ description.it | default({}) | tojson | safe }}
    },

    f: {
      car: "",
      car_class: "",
      car_from: "",
      ...{{ description.fuhrpark | default({}) | tojson | safe }}
    },

    /* ===============================
       VALIDATION RULES
       (nur relevant fÃ¼r COMPLETE)
    =============================== */
    rules: {
      /* ===============================
         PERSONAL / HR
      =============================== */
      first_name: { required: true },
      last_name: { required: true },
      title: { required: true },
      private_address: { required: true },
      start_date: { required: true },
      homeoffice: { required: true },
      department: { required: true },
      cost_center: { required: true },
      location: { required: true },
      contract_company: { required: true },

      personal_number: { required: true },

      supervisor_hr_id: { required: true },
      contact_person_id: { required: true },

      /* ===============================
         ALLGEMEIN
      =============================== */
      appearance_company: { required: true },
      appearance_address: { required: true },

      /* ===============================
         IT â€“ GRUNDDATEN
      =============================== */
      main_cost_center: { required: true },
      work_start: { required: true },

      /* ===============================
         IT â€“ SIGNATUR
      =============================== */
      signature_title: { required: true },
      signature_street: { required: true },
      signature_zip: {
        required: true,
        pattern: /^[0-9]{5}$/
      },
      signature_city: { required: true },
      signature_mobile: { required: true },
      signature_phone: { required: true },

      /* ===============================
         IT â€“ TIMEBUTLER
      =============================== */
      vacation_year: { required: true },
      vacation_start_year: { required: true },
      holiday_rule: { required: true },
      tb_supervisor_id: { required: true },

      /* ===============================
         IT â€“ SYSTEME
      =============================== */
      datev_user: { required: true },
      other_systems: { required: true },

      /* ===============================
         POSTFÃ„CHER
      =============================== */
      mailboxes_additional: { required: true },
      mailboxes_notes: {
        requiredIf() {
          return this.it.mailboxes.additional === "Ja";
        }
      },

      /* ===============================
         FUHRPARK
      =============================== */
      car: { required: true },
      car_class: {
        requiredIf() {
          return this.f.car === "Ja";
        }
      },
      car_from: {
        requiredIf() {
          return this.f.car === "Ja";
        }
      },

      /* ===============================
         TICKET / WORKFLOW
      =============================== */
      accountable_id: { required: true },
      supervisor_id: { required: true }
    },



    /* ===============================
       VALUE RESOLVER (fÃ¼r baseForm)
    =============================== */
    getValue(field) {
      // PERSONAL
      if (field in this.p) return this.p[field];

      // ALLGEMEIN
      if (field in this.a) return this.a[field];

      // FUHRPARK
      if (field in this.f) return this.f[field];

      // IT â€“ FLACH
      if (field in this.it) return this.it[field];

      // IT â€“ SIGNATURE
      if (field.startsWith("signature_")) {
        const key = field.replace("signature_", "");
        return this.it.signature?.[key] ?? "";
      }

      // IT â€“ TIMEBUTLER
      if (field === "vacation_year") return this.it.timebutler?.vacation_year ?? "";
      if (field === "vacation_start_year") return this.it.timebutler?.vacation_start_year ?? "";
      if (field === "holiday_rule") return this.it.timebutler?.holiday_rule ?? "";

      // IT â€“ DATEV
      if (field === "datev_user") return this.it.datev?.user ?? "";

      // IT â€“ MAILBOXES
      if (field === "mailboxes_additional") return this.it.mailboxes?.additional ?? "";
      if (field === "mailboxes_notes") return this.it.mailboxes?.notes ?? "";

      // FALLBACK DOM (fÃ¼r Dropdowns & Assignees)
      return document.querySelector(`[name="${field}"]`)?.value ?? "";
    },





    /* ===============================
       INIT
    =============================== */
    async init() {
      /* ===============================
         COMPANIES LADEN
      =============================== */
      try {
        const res = await fetch("/api/companies");
        const data = await res.json();
        this.companies = data.companies || [];
      } catch {
        this.companies = [];
      }

      /* ===============================
         USER-DROPDOWN EVENTS (ðŸ”¥ WICHTIG)
      =============================== */
      this.$el.addEventListener("user-selected", (e) => {
        const { fieldId, id, name } = e.detail;

        if (fieldId === "supervisor_hr_id") {
          this.p.supervisor_hr_id = id;
          this.p.supervisor_hr_name = name;
        }

        if (fieldId === "contact_person_id") {
          this.p.contact_person_id = id;
          this.p.contact_person_name = name;
        }

        if (fieldId === "tb_supervisor_id") {
          this.it.timebutler.supervisor_id = id;
          this.it.timebutler.supervisor_name = name;
        }
      });

      /* ===============================
         SELECT-REBIND (Company Selects)
      =============================== */
      const contract = this.p.contract_company;
      const appearance = this.a.appearance_company;

      this.$nextTick(() => {
        this.p.contract_company = "";
        this.a.appearance_company = "";

        this.$nextTick(() => {
          this.p.contract_company = contract;
          this.a.appearance_company = appearance;
        });
      });

      /* ===============================
         ASSIGNEE PRESET
      =============================== */
      this.$nextTick(() => {
        this.$refs.assigneeId.value = "{{ ticket.assignee_id }}";
        this.$refs.assigneeName.value = "{{ ticket.assignee_name }}";
      });

      /* ===============================
         INITIAL DESCRIPTION SYNC
      =============================== */
      this.updateDescription();

      /* ===============================
         VALIDATION RESET
      =============================== */
      this.validationTriggered = false;
    },




    /* ===============================
       DESCRIPTION SYNC
    =============================== */
updateDescription() {

  this.$refs.description.value = JSON.stringify(
    {
      personal: this.p,
      allgemein: this.a,
      it: this.it,
      fuhrpark: this.f
    },
    null,
    2
  );
},


    /* ===============================
       SUBMIT
    =============================== */
    submitEdit(action = "save", event) {
  // ðŸ”¥ WICHTIG: erst syncen

  if (action === "complete") {
    if (!this.validateOrScroll()) return;

    const ok = confirm(
      "Wollen Sie den Auftrag wirklich abschlieÃŸen?\n\n" +
      "Eine Bearbeitung ist danach nicht mehr mÃ¶glich."
    );
    if (!ok) return;
  }

  this.updateDescription();

  const form = event.target.closest("form");
  if (!form) return;

  const input = document.createElement("input");
  input.type = "hidden";
  input.name = "action";
  input.value = action;
  form.appendChild(input);

  form.submit();
},




    /* ===============================
       WEITERGEBEN
    =============================== */
    applyAssignee() {
      let id = null;
      let name = null;

      if (this.assigneeMode === "accountable") {
        id = document.querySelector('[name="accountable_id"]')?.value;
        name = document.querySelector('[name="accountable_name"]')?.value;
      }

      if (this.assigneeMode === "supervisor") {
        id = document.querySelector('[name="supervisor_id"]')?.value;
        name = document.querySelector('[name="supervisor_name"]')?.value;
      }

      if (this.assigneeMode === "custom") {
        id = document.querySelector('[name="custom_assignee_id"]')?.value;
        name = document.querySelector('[name="custom_assignee_name"]')?.value;
      }

      if (!id) {
        alert("Bitte Bearbeiter auswÃ¤hlen");
        return;
      }

      this.$refs.assigneeId.value = id;
      this.$refs.assigneeName.value = name;
      this.currentAssigneeName = name;
      this.openAssignModal = false;
    }
  };
}
</script>

{% endblock %}
