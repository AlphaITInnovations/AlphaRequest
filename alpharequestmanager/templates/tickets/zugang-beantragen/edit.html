{% extends "base.html" %}
{% block title %}Zugang beantragen – Auftrag bearbeiten{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-8">

<form
  method="post"
  action="/tickets/update/{{ ticket.id }}"
  class="flex flex-col gap-8"
  x-data="zugangEditForm()"
  x-init="init()"
  @keydown.enter.prevent="if ($event.target.tagName !== 'TEXTAREA') $event.preventDefault()"
>

  <!-- ================================================= -->
  <!-- REQUIRED BACKEND FIELDS -->
  <!-- ================================================= -->
  <input type="hidden" name="action" x-ref="action" value="save">
  <input type="hidden" name="ticket_type" value="zugang-beantragen">
  <input type="hidden" name="description" x-ref="description">

  <!-- Backend verlangt diese IMMER -->
  <input type="hidden" name="assignee_id" x-ref="assigneeId">
  <input type="hidden" name="assignee_name" x-ref="assigneeName">

  <div x-ref="formTop"></div>

  <div class="flex flex-col lg:flex-row gap-8">

    <!-- ================================================= -->
    <!-- LEFT: DETAILS -->
    <!-- ================================================= -->
    <aside class="w-full lg:w-[360px] bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-6">

      <h2 class="font-semibold text-lg">Details</h2>

      {% set label = "Verantwortlicher" %}
      {% set field_id = "accountable_id" %}
      {% set field_name = "accountable_name" %}
      {% set initial_id = ticket.accountable_id %}
      {% set initial_name = ticket.accountable_name %}
      {% include "components/user-dropdown.html" %}

      {% set label = "Vorgesetzter" %}
      {% set field_id = "supervisor_id" %}
      {% set field_name = "supervisor_name" %}
      {% set initial_id = ticket.supervisor_id %}
      {% set initial_name = ticket.supervisor_name %}
      {% include "components/user-dropdown.html" %}

      <div>
        <label class="font-medium">Priorität *</label>
        <select name="priority"
                x-model="priority"
                class="w-full mt-1 p-2 rounded border dark:bg-gray-700">
          {% for p in ["low","medium","high","critical"] %}
          <option value="{{ p }}">{{ p|capitalize }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="font-medium">Kommentar</label>
        <textarea name="comment"
                  class="w-full mt-1 p-2 rounded border h-28 dark:bg-gray-700">{{ ticket.comment }}</textarea>
      </div>

    </aside>

    <!-- ================================================= -->
    <!-- RIGHT: FORM CONTENT -->
    <!-- ================================================= -->
    {% include "tickets/zugang-beantragen/form.html" %}

  </div>

  <!-- ================================================= -->
  <!-- ACTIONS -->
  <!-- ================================================= -->
  <div class="flex justify-between gap-4">

    <a href="/dashboard" class="px-5 py-2.5 bg-gray-300 rounded-md">
      Abbrechen
    </a>

    <div class="flex gap-4">

      <button type="submit"
              @click="$refs.action.value='save'"
              class="px-6 py-2.5 bg-primary text-white rounded-md">
        Speichern
      </button>

      <button type="submit"
              @click="
                validationTriggered = true;

                if (hasErrors()) {
                  scrollToTop();
                  $event.preventDefault();
                  return;
                }

                if (!confirm('Auftrag wirklich abschließen?\nDanach ist keine Bearbeitung mehr möglich.')) {
                  $event.preventDefault();
                  return;
                }

                $refs.action.value = 'complete';
              "
              :class="!hasErrors()
                ? 'bg-emerald-600 hover:bg-emerald-700'
                : 'bg-gray-400 cursor-not-allowed'"
              class="px-6 py-2.5 text-white rounded-md transition">
        Abschließen
      </button>

    </div>
  </div>

</form>
</div>

<!-- =========================================================
     PREFILL USER-DROPDOWNS (VOR ALPINE INIT)
========================================================= -->
<script>
(function () {
  const personal = {{ description.personal | tojson }};
  const it = {{ description.it | tojson }};

  function patch(fieldId, id, name) {
    const el = document.querySelector(`[data-field-id="${fieldId}"]`);
    if (!el) return;
    el.dataset.initialId = id || "";
    el.dataset.initialName = name || "";
  }

  // HR
  patch("supervisor_hr_id", personal.supervisor_hr_id, personal.supervisor_hr_name);
  patch("contact_person_id", personal.contact_person_id, personal.contact_person_name);

  // Timebutler
  patch(
    "tb_supervisor_id",
    it?.timebutler?.supervisor_id,
    it?.timebutler?.supervisor_name
  );
})();
</script>

<script>
function zugangEditForm() {
  return {
    priority: "{{ ticket.priority.value }}",
    validationTriggered: false,
    companies: [],

    p: {{ description.personal | tojson }},
    a: {{ description.allgemein | tojson }},
    it: {{ description.it | tojson }},
    f: {{ description.fuhrpark | tojson }},

    async init() {
      await this.loadCompanies();

      // Firmen-Selects korrekt neu binden
      this.$nextTick(() => {
        this.p.contract_company = this.p.contract_company;
        this.a.appearance_company = this.a.appearance_company;
      });

      this.$refs.assigneeId.value = "{{ ticket.assignee_id }}";
      this.$refs.assigneeName.value = "{{ ticket.assignee_name }}";

      this.$el.addEventListener("submit", () => {
        this.syncHRFromDropdowns();

        this.$refs.description.value = JSON.stringify({
          personal: this.p,
          allgemein: this.a,
          it: this.it,
          fuhrpark: this.f
        }, null, 2);
      });
    },

    async loadCompanies() {
      try {
        const res = await fetch("/api/companies");
        const data = await res.json();
        this.companies = data.companies || [];
      } catch {
        this.companies = [];
      }
    },

    syncHRFromDropdowns() {
      const sid = document.querySelector('[name="supervisor_hr_id"]')?.value;
      const sname = document.querySelector('[name="supervisor_hr_name"]')?.value;
      if (sid) this.p.supervisor_hr_id = sid;
      if (sname) this.p.supervisor_hr_name = sname;

      const cid = document.querySelector('[name="contact_person_id"]')?.value;
      const cname = document.querySelector('[name="contact_person_name"]')?.value;
      if (cid) this.p.contact_person_id = cid;
      if (cname) this.p.contact_person_name = cname;

      const tbid = document.querySelector('[name="tb_supervisor_id"]')?.value;
      const tbname = document.querySelector('[name="tb_supervisor_name"]')?.value;
      if (tbid) this.it.timebutler.supervisor_id = tbid;
      if (tbname) this.it.timebutler.supervisor_name = tbname;
    },

    /* ===================================================
       PFLICHTFELDER – ABHÄNGIG VON AUSWAHL
    =================================================== */
    requiredPaths() {
      const req = [
        "p.first_name",
        "p.last_name",
        "p.title",
        "p.private_address",
        "p.start_date",
        "p.homeoffice",
        "p.department",
        "p.cost_center",
        "p.location",
        "p.contract_company",
        "p.supervisor_hr_id",
        "p.contact_person_id",
        "a.appearance_company",
        "it.main_cost_center",
        "it.work_start"
      ];

      if (this.f.car === "Ja") {
        req.push("f.car_class", "f.car_from");
      }

      if (this.it.mailboxes?.additional === "Ja") {
        req.push("it.mailboxes.notes");
      }

      return req;
    },

    hasErrors() {
      return this.requiredPaths().some(path => {
        const value = path.split(".").reduce((o, k) => o?.[k], this);
        return value === null || value === "";
      });
    },

    fieldClass(path) {
      if (!this.validationTriggered) return "input";
      const value = path.split(".").reduce((o, k) => o?.[k], this);
      return value === null || value === ""
        ? "input input-error"
        : "input";
    },

    scrollToTop() {
      this.$refs.formTop.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }
}
</script>

<style>
.input{
  width:100%;
  margin-top:.25rem;
  padding:.5rem .75rem;
  border-radius:.375rem;
  background-color:var(--field-bg);
  color:var(--text);
  border:1px solid var(--border);
}
.input-error{
  border-color:#EF4444;
  background-color:color-mix(in oklab, var(--field-bg) 85%, #EF4444 15%);
}
</style>

{% endblock %}
