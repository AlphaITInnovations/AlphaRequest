{% extends "tickets/_base_ticket.html" %}

{% set form_action = "/tickets" %}
{% set alpine_component = "zugangPhase1Form()" %}

{% block hidden_fields %}
<input type="hidden" name="ticket_type" value="zugang-beantragen">
<input type="hidden" name="description" x-ref="description">
{% endblock %}

{% block ticket_details %}
  {% include "tickets/partials/_ticket_details.html" %}
{% endblock %}

{% block ticket_fields %}
  {% include "tickets/zugang-beantragen/_form_fields.html" %}
{% endblock %}

{% block ticket_actions %}
  {% include "tickets/partials/_ticket_actions.html" %}
{% endblock %}

{% block extra_js %}
<script>
function zugangPhase1Form() {
  return {
    /* =================================================
       BASE FORM (VALIDATION ENGINE)
    ================================================= */
    ...baseForm(),

    /* =================================================
       MODE
    ================================================= */
    phase: "create",
    isCreate: true,
    modalOpen: false,

    /* =================================================
       DATA
    ================================================= */
    companies: [],

    p: {
      first_name: "",
      last_name: "",
      title: "",
      private_address: "",
      start_date: "",
      homeoffice: "",
      department: "",
      cost_center: "",
      location: "",
      contract_company: "",
      notes: "",

      supervisor_hr_id: "",
      supervisor_hr_name: "",
      contact_person_id: "",
      contact_person_name: "",
      personal_number: ""
    },

    a: {
      appearance_company: "",
      appearance_address: ""
    },

    it: {
      main_cost_center: "",
      work_start: "",
      signature: {
        title: "",
        street: "",
        zip: "",
        city: "",
        mobile: "",
        phone: ""
      },
      timebutler: {
        vacation_year: "",
        vacation_start_year: "",
        holiday_rule: "",
        supervisor_id: "",
        supervisor_name: ""
      },
      datev: { user: "" , required_rights: ""},
      other_systems: "",
      mailboxes: { additional: "", notes: "" },
      additional_cost_centers: ""
    },

    f: {
      car: "",
      car_class: "",
      car_from: ""
    },

    /* =================================================
       VALIDATION RULES (ðŸ”¥ DAS IST DER KERN ðŸ”¥)
    ================================================= */
    rules: {
      first_name: { required: true },
      last_name: { required: true },
      title: { required: true },
      private_address: { required: true },
      start_date: { required: true },
      homeoffice: { required: true },
      department: { required: true },
      cost_center: { required: true },
      location: { required: true },
      contract_company: { required: true },

      personal_number: { required: true },

      supervisor_hr_id: { required: true },
      contact_person_id: { required: true },

      accountable_id: { required: true },
      supervisor_id: { required: true }
    },

    /* =================================================
       VALUE RESOLVER (wichtig fÃ¼r baseForm)
    ================================================= */
    getValue(field) {
      const dom = document.querySelector(`[name="${field}"]`)?.value;
      if (dom !== undefined && dom !== "") return dom;

      if (this.p && field in this.p) return this.p[field];

      return "";
    },


    /* =================================================
       INIT
    ================================================= */
    async init() {
      try {
        const res = await fetch("/api/companies");
        const data = await res.json();
        this.companies = data.companies || [];
      } catch {
        this.companies = [];
      }
    },

    /* =================================================
       PERSONALNUMMER
    ================================================= */
    async generatePersonalnummer() {
      if (!this.isCreate) return;
      if (!confirm("Nummer wirklich generieren?")) return;

      try {
        const res = await fetch("/api/personalnummer/next");
        const data = await res.json();
        this.p.personal_number = String(data.personalnummer);
      } catch {
        alert("Fehler beim Generieren der Personalnummer");
      }
    },

    /* =================================================
       CREATE FLOW
    ================================================= */
    openAssigneeModal() {
      this.validationTriggered = false;
      this.$nextTick(() => {
        if (!this.validateOrScroll()) return;
        this.modalOpen = true;
      });
    },

    chooseAssignee(type) {
      const id = document.querySelector(`[name="${type}_id"]`)?.value;
      const name = document.querySelector(`[name="${type}_name"]`)?.value;

      this.$refs.assigneeId.value = id;
      this.$refs.assigneeName.value = name;


      this.p.supervisor_hr_id =
        document.querySelector('[name="supervisor_hr_id"]')?.value || "";

      this.p.supervisor_hr_name =
        document.querySelector('[name="supervisor_hr_name"]')?.value || "";

      this.p.contact_person_id =
        document.querySelector('[name="contact_person_id"]')?.value || "";

      this.p.contact_person_name =
        document.querySelector('[name="contact_person_name"]')?.value || "";

      /* ===============================
         DESCRIPTION SERIALISIEREN
      =============================== */
      this.$refs.description.value = JSON.stringify(
        {
          personal: this.p,
          allgemein: this.a,
          it: this.it,
          fuhrpark: this.f
        },
        null,
        2
      );

      this.modalOpen = false;
      this.$el.submit();
    }

  };
}
</script>
{% endblock %}
