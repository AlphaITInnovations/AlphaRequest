{% extends "base.html" %}

{% block head %}
  {{ super() }}

  <!-- ===============================
       BASE FORM STYLES
  =============================== -->
  <style>
    .input {
      width: 100%;
      padding: .5rem .75rem;
      border-radius: .375rem;
      background-color: var(--field-bg);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .input:focus {
      outline: none;
      box-shadow: var(--ring);
      border-color: transparent;
    }
    .input-error {
      border-color: #EF4444;
      background-color: color-mix(in oklab, var(--field-bg) 85%, #EF4444 15%);
    }

    .field-shell {
      border: 1px solid var(--border);
      border-radius: .375rem;
      padding: .5rem;
      background-color: var(--field-bg);
    }
    .field-shell-error {
      border-color: #EF4444;
      background-color: color-mix(in oklab, var(--field-bg) 85%, #EF4444 15%);
    }
  </style>

  <!-- ===============================
       BASE FORM LOGIC (GLOBAL)
  =============================== -->
  <script>
    window.baseForm = function () {
      return {
        showErrorBar: false,
        errorCount: 0,
        errorMessage: "Bitte alle Felder korrekt ausf√ºllen.",
        /* -----------------------------
           VALIDATION CORE
        ----------------------------- */
        validationTriggered: false,

        isEmpty(v) {
          return v === null || v === undefined || v === "";
        },

        /* rules:
           {
             fieldName: { required: true, pattern: /^[0-9]{5}$/ }
           }
        */
        isInvalid(field, value) {
          const rule = this.rules?.[field];
          if (!rule) return false;

          // üîπ conditional required
          if (rule.requiredIf) {
            const requiredNow = rule.requiredIf.call(this);
            if (!requiredNow) return false;
            return this.isEmpty(value);
          }

          // üîπ normal required
          if (rule.required && this.isEmpty(value)) {
            return true;
          }

          // üîπ pattern
          if (rule.pattern && !this.isEmpty(value) && !rule.pattern.test(value)) {
            return true;
          }

          return false;
        },


        /* -----------------------------
           CLASSES
        ----------------------------- */
        inputClass(field, value) {
          return [
            "input",
            this.validationTriggered && this.isInvalid(field, value)
              ? "input-error"
              : ""
          ];
        },

        shellClass(field) {
          const value = this.getValue(field);

          return this.validationTriggered && this.isInvalid(field, value)
            ? "field-shell field-shell-error"
            : "field-shell";
        },


        /* -----------------------------
           VALIDATE + SCROLL
        ----------------------------- */
validateOrScroll() {
  this.validationTriggered = true;

  const errors = [];

  Object.keys(this.rules || {}).forEach(field => {
    const value = this.getValue(field);
    const invalid = this.isInvalid(field, value);

    if (invalid) {
      errors.push({ field, value, rule: this.rules[field] });
    }
  });

  this.errorCount = errors.length;
  this.showErrorBar = errors.length > 0;

  if (errors.length) {
    console.group("‚ùå Validation errors (" + errors.length + ")");
    console.table(errors);
    console.groupEnd();

    this.$refs.formTop?.scrollIntoView({
      behavior: "smooth",
      block: "start"
    });

    return false;
  }

  return true;
}





      };
    };
  </script>


{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-8 pb-[6.5rem]">

    <form
      method="post"
      action="{{ form_action }}"
      class="flex flex-col gap-8"
      {% if alpine_component %}
        x-data="{{ alpine_component }}"
        x-init="init && init()"
      {% endif %}

    >


    <!-- Scroll Target -->
    <div x-ref="formTop"></div>
    <!-- Red Info Bar (Validation) -->
    <div
      x-show="showErrorBar"
      x-transition.opacity.duration.150ms
      class="rounded-lg border border-red-300 bg-red-50 text-red-900 px-4 py-3"
      role="alert"
    >
      <div class="font-semibold" x-text="errorMessage"></div>
      <div class="text-sm opacity-90" x-show="errorCount" x-text="`Fehler: ${errorCount}`"></div>
    </div>

    {% block hidden_fields %}{% endblock %}

    <div class="flex flex-col lg:flex-row gap-8">

      <!-- LEFT: DETAILS -->
      <aside class="w-full lg:w-[360px] bg-white dark:bg-gray-800 border rounded-xl shadow p-6 space-y-6">
        {% block ticket_details %}{% endblock %}
      </aside>

      <!-- RIGHT: FIELDS -->
      <section class="flex-1 bg-white dark:bg-gray-800 border rounded-xl shadow p-8 space-y-12">
        {% block ticket_fields %}{% endblock %}
      </section>

    </div>

    {% block ticket_actions %}{% endblock %}
    {% block extra_js %}{% endblock %}

  </form>
</div>
{% endblock %}
