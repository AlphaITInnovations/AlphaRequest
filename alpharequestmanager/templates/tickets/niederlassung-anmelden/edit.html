{% extends "base.html" %}
{% block title %}Hardware – Ticket bearbeiten{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-8">

<form
    method="post"
    action="/tickets/update/{{ ticket.id }}"
    class="flex flex-col gap-8"
    x-data="hardwareEditForm('{{ ticket.description | e }}')"
    x-init="init()"
>

<div class="flex flex-col lg:flex-row gap-8">

    <!-- ================= LEFT: DETAILS ================= -->
    <aside class="w-full lg:w-[340px] flex-shrink-0
                  bg-white dark:bg-gray-800 border rounded-xl shadow p-6">

        <h2 class="font-semibold text-lg mb-6">Details</h2>

        <!-- USER DROPDOWN -->
        {% include "components/user-dropdown.html" %}

        <!-- PRIORITY -->
        <div class="mt-6">
            <label class="font-medium">Priorität *</label>
            <select name="priority"
                    class="w-full mt-1 p-2 rounded border dark:bg-gray-700">
                {% for p in ["low","medium","high","critical"] %}
                <option value="{{ p }}"
                        {% if ticket.priority == p %}selected{% endif %}>
                    {{ p|capitalize }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- COMMENT -->
        <div class="mt-6">
            <label class="font-medium">Kommentar</label>
            <textarea name="comment"
                      class="w-full mt-1 p-2 rounded border h-28 dark:bg-gray-700"
                      placeholder="Optional…">{{ ticket.comment }}</textarea>
        </div>

    </aside>

    <!-- ================= RIGHT: CONTENT ================= -->
    <section class="flex-1 bg-white dark:bg-gray-800 border rounded-xl shadow p-8">

        <input type="hidden" name="ticket_type" value="hardware">

        <h2 class="text-xl font-semibold mb-6">Hardware Details</h2>

        {% for i in range(1,6) %}
        <div class="mb-6">
            <label class="font-medium">Feld {{ i }}</label>
            <input
                type="text"
                name="feld{{ i }}"
                class="w-full mt-1 p-3 rounded border dark:bg-gray-700"
            >
        </div>
        {% endfor %}

        <!-- DESCRIPTION JSON -->
        <input type="hidden" name="description" x-ref="description">

    </section>

</div>

<!-- ================= ACTIONS ================= -->
<div class="flex justify-end gap-4">
    <a href="/dashboard"
       class="px-5 py-2.5 bg-gray-300 dark:bg-gray-600 rounded-md">
        Abbrechen
    </a>

    <button type="submit"
            class="px-6 py-2.5 bg-primary text-white rounded-md">
        Speichern
    </button>
</div>

</form>

</div>

<!-- ================= Alpine Logic ================= -->
<script>
function hardwareEditForm(rawDescription) {
    return {
        init() {
            let data = {};
            try {
                data = JSON.parse(rawDescription);
            } catch (e) {
                console.warn("Beschreibung ist kein gültiges JSON", e);
            }

            for (let i = 1; i <= 5; i++) {
                const field = document.querySelector(`[name=feld${i}]`);
                if (field && data[`feld${i}`] !== undefined) {
                    field.value = data[`feld${i}`];
                }
            }

            this.$el.addEventListener("submit", () => {
                const d = {};
                for (let i = 1; i <= 5; i++) {
                    d[`feld${i}`] =
                        this.$el.querySelector(`[name=feld${i}]`).value;
                }
                this.$refs.description.value = JSON.stringify(d);
            });
        }
    }
}
</script>

{% endblock %}
