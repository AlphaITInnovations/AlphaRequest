{% extends "tickets/_base_ticket.html" %}
{% block title %}Hardwareauftrag bearbeiten{% endblock %}

{% set form_action = "/tickets/update/" ~ ticket.id %}
{% set alpine_component = "hardwareEditForm()" %}

{% block hidden_fields %}
  <input type="hidden" name="description" x-ref="description">
{% endblock %}

{% block ticket_details %}
  {% include "tickets/partials/_ticket_details.html" %}
{% endblock %}

{% block ticket_fields %}
  {% include "tickets/hardware/_form_fields.html" %}
{% endblock %}

{% block ticket_actions %}
  {% include "tickets/partials/_ticket_actions.html" %}
{% endblock %}

{% block extra_js %}
<script>
function hardwareEditForm() {
  return {
    /* ===============================
       BASE FORM
    =============================== */
    ...baseForm(),

    /* ===============================
       MODE
    =============================== */
    phase: "edit",
    isCreate: false,

    /* ===============================
       ASSIGN / WEITERGEBEN
    =============================== */
    openAssignModal: false,
    assigneeMode: "accountable",
    currentAssigneeName: "{{ ticket.assignee_name }}",

    /* ===============================
       DATA (üî• PREFILL AUS DB üî•)
    =============================== */
    companies: [],

    data: {
      mitarbeiterTyp: "",
      vorname: "",
      nachname: "",
      kostenstelle: "",
      firma: "",

      addr_strasse: "",
      addr_nr: "",
      addr_plz: "",
      addr_stadt: "",
      addr_tuerschild: "",

      lieferungBis: "",

      monitor: { benoetigt: false, anzahl: 1 },
      geraet: "",

      artikel: {
        Notebook: false,
        MiniPC: false,
        Dockingstation: false,
        MausUndTastatur: false,
        Headset: false,
        Webcam: false,
        HandyUndSim: false
      },

      dockingVorhanden: false,
      bemerkung: "",
      grundBestellung: "",

      /* üî• HIER IST DER FIX üî• */
      ...({{ description.hardware | default({}) | tojson | safe }})
    },

    /* ===============================
       VALIDATION
    =============================== */
    rules: {
      mitarbeiterTyp: { required: true },

      vorname: { required: true },
      nachname: { required: true },
      kostenstelle: { required: true },
      firma: { required: true },

      addr_strasse: { required: true },
      addr_nr: { required: true },
      addr_plz: { required: true },
      addr_stadt: { required: true },

      lieferungBis: { required: true },

      grundBestellung: {
        requiredIf() {
          return this.data.mitarbeiterTyp === "Bestandsmitarbeiter";
        }
      },

      accountable_id: { required: true },
      supervisor_id: { required: true }
    },

    /* ===============================
       VALUE RESOLVER
    =============================== */
    getValue(field) {
      if (field in this.data) return this.data[field] ?? "";
      return document.querySelector(`[name="${field}"]`)?.value ?? "";
    },

    /* ===============================
       INIT
    =============================== */
    async init() {
      /* Firmen */
      try {
        const res = await fetch("/api/companies");
        const json = await res.json();
        this.companies = json.companies || [];
      } catch {
        this.companies = [];
      }

      /* Assignee PRESET (üî• WICHTIG) */
      this.$nextTick(() => {
        this.$refs.assigneeId.value = "{{ ticket.assignee_id }}";
        this.$refs.assigneeName.value = "{{ ticket.assignee_name }}";
        this.updateDescription();
        this.validationTriggered = false;
      });
    },

    /* ===============================
       DESCRIPTION ‚Üí DB FORMAT
    =============================== */
    updateDescription() {
      this.$refs.description.value = JSON.stringify(
        {
          hardware: this.data
        },
        null,
        2
      );
    },

    /* ===============================
       SUBMIT
    =============================== */
    submitEdit(action = "save", event) {
      if (action === "complete") {
        if (!this.validateOrScroll()) return;

        const ok = confirm(
          "Wollen Sie den Auftrag wirklich abschlie√üen?\n\n" +
          "Danach ist keine Bearbeitung mehr m√∂glich."
        );
        if (!ok) return;
      }

      this.updateDescription();

      const form = event.target.closest("form");
      if (!form) return;

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "action";
      input.value = action;
      form.appendChild(input);

      form.submit();
    }
  };
}
</script>
{% endblock %}
