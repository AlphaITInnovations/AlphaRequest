{% extends "base.html" %}
{% block title %}Hardware – Ticket bearbeiten{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-8">

<form
    method="post"
    action="/tickets/update/{{ ticket.id }}"
    class="flex flex-col gap-8"
    x-data="hardwareEditForm('{{ ticket.description | e }}', '{{ priority }}')"
    x-init="init()"
    @keydown.enter.prevent
>
    <!-- ACTION (save | complete) -->
    <input type="hidden" name="action" x-ref="action" value="save">

    <!-- ================= LAYOUT ================= -->
    <div class="flex flex-col lg:flex-row gap-8">

        <!-- ================= LEFT ================= -->
        <aside class="w-full lg:w-[340px] flex-shrink-0
                      bg-white dark:bg-gray-800 border rounded-xl shadow p-6">

            <h2 class="font-semibold text-lg mb-6">Details</h2>

            <!-- ASSIGNEE -->
            {% include "components/user-dropdown.html" %}

            <!-- PRIORITY -->
            <div class="mt-6">
                <label class="font-medium">Priorität *</label>
                <select name="priority"
                        x-model="priority"
                        class="w-full mt-1 p-2 rounded border dark:bg-gray-700">
                    {% for p in ["low","medium","high","critical"] %}
                    <option value="{{ p }}">{{ p|capitalize }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- COMMENT -->
            <div class="mt-6">
                <label class="font-medium">Kommentar</label>
                <textarea name="comment"
                          class="w-full mt-1 p-2 rounded border h-28 dark:bg-gray-700"
                          placeholder="Optional…">{{ ticket.comment }}</textarea>
            </div>
        </aside>

        <!-- ================= RIGHT ================= -->
        <section class="flex-1 bg-white dark:bg-gray-800 border rounded-xl shadow p-8">

            <input type="hidden" name="ticket_type" value="hardware">

            <h2 class="text-xl font-semibold mb-6">Hardware Details</h2>

            {% for i in range(1,6) %}
            <div class="mb-6">
                <label class="font-medium">Feld {{ i }} *</label>
                <input
                    type="text"
                    name="feld{{ i }}"
                    x-model="fields.feld{{ i }}"
                    class="w-full mt-1 p-3 rounded border dark:bg-gray-700">
            </div>
            {% endfor %}

            <!-- DESCRIPTION JSON -->
            <input type="hidden" name="description" x-ref="description">
        </section>
    </div>

    <!-- ================= ACTIONS ================= -->
    <div class="flex items-end justify-between gap-6">

        <!-- HINWEIS -->
        <div class="min-h-[3rem] flex items-center">
            <div
                class="text-base font-medium text-amber-600 dark:text-amber-400 transition-opacity"
                :class="canComplete ? 'opacity-0' : 'opacity-100'">
                Bitte alle Pflichtfelder ausfüllen, um das Ticket abschließen zu können.
            </div>
        </div>

        <!-- BUTTONS -->
        <div class="flex gap-4">

            <a href="/dashboard"
               class="px-5 py-2.5 bg-gray-300 dark:bg-gray-600 rounded-md">
                Abbrechen
            </a>

            <!-- SAVE -->
            <button type="submit"
                    @click="$refs.action.value='save'"
                    class="px-6 py-2.5 bg-primary text-white rounded-md">
                Speichern
            </button>

            <!-- COMPLETE -->

            <button
                type="submit"
                @click="
                    if (!canComplete) {
                        $event.preventDefault();
                        return;
                    }

                    if (!confirm(
                      'Wollen Sie dieses Ticket wirklich abschließen?\n\n' +
                      'Der Auftrag kann danach nicht mehr bearbeitet werden.'
                    )) {
                        $event.preventDefault();
                        return;
                    }

                    $refs.description.value = JSON.stringify(fields);
                    $refs.action.value = 'complete';
                "
                :disabled="!canComplete"
                :class="canComplete
                  ? 'bg-emerald-600 hover:bg-emerald-700'
                  : 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed'"
                class="px-6 py-2.5 text-white rounded-md transition">
                Abschließen
            </button>


        </div>
    </div>
</form>
</div>

<!-- ================= ALPINE ================= -->
<script>
function hardwareEditForm(rawDescription, initialPriority) {
    return {
        fields: {
            feld1: "",
            feld2: "",
            feld3: "",
            feld4: "",
            feld5: ""
        },

        priority: initialPriority,

        init() {
            try {
                const data = JSON.parse(rawDescription);
                Object.keys(this.fields).forEach(k => {
                    if (data[k]) this.fields[k] = data[k];
                });
            } catch {
                console.warn("Description ist kein gültiges JSON");
            }

            this.$el.addEventListener("submit", () => {
                this.$refs.description.value = JSON.stringify(this.fields);
            });
        },

        get canComplete() {
            if (!this.priority) return false;
            return Object.values(this.fields).every(v => v && v.trim() !== "");
        }
    }
}
</script>

{% endblock %}
