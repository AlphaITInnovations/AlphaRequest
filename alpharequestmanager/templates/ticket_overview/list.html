{% extends "base.html" %}
{% block title %}Ticket-√úbersicht{% endblock %}

{% block head %}
<script>
  window._TICKETS = {{ tickets | tojson }};
</script>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('ticketsManager', () => ({
    items: window._TICKETS,

    filter: 'all',
    search: '',
    selected: [],

    statuses: ['all', 'in_request', 'in_progress', 'archived', 'rejected'],

    get filtered() {
      let list = this.filter === 'all'
        ? this.items
        : this.items.filter(t => t.status === this.filter)

      if (this.search.trim()) {
        const q = this.search.toLowerCase()
        list = list.filter(t =>
          (t.title || '').toLowerCase().includes(q) ||
          (t.creator || '').toLowerCase().includes(q) ||
          String(t.id).includes(q)
        )
      }
      return list
    },

    toggle(id) {
      this.selected.includes(id)
        ? this.selected = this.selected.filter(x => x !== id)
        : this.selected.push(id)
    },

    toggleAll(e) {
      this.selected = e.target.checked
        ? this.filtered.map(t => t.id)
        : []
    },

    async deleteSelected() {
      if (!this.selected.length) return
      if (!confirm(`${this.selected.length} Ticket(s) wirklich l√∂schen?`)) return

      await Promise.all(
        this.selected.map(id =>
          fetch(`/tickets/${id}/delete`, { method: 'POST' })
        )
      )
      location.reload()
    },

    statusClass(s) {
      return {
        in_request: 'bg-primary/15 text-primary',
        in_progress: 'bg-yellow-100 text-yellow-800',
        archived: 'bg-gray-200 text-gray-700',
        rejected: 'bg-red-100 text-red-700'
      }[s] || 'bg-gray-100 text-gray-600'
    },

    priorityClass(p) {
      return {
        low: 'bg-gray-200 text-gray-800',
        medium: 'bg-primary/20 text-primary',
        high: 'bg-orange-200 text-orange-900',
        critical: 'bg-red-200 text-red-900'
      }[p] || 'bg-gray-200 text-gray-800'
    },

    // ‚úÖ Timestamp-Fix: ISO ohne TZ wird als UTC behandelt, dann lokal formatiert
    formatLocal(ts) {
      if (!ts) return '‚Äì'
      let s = String(ts).trim()

      // Wenn kein Zeitzoneninfo vorhanden ‚Üí als UTC interpretieren
      // Beispiele ohne TZ: "2026-01-12T09:00:28.984171"
      // Beispiele mit TZ:  "2026-01-12T09:00:28.984171Z" oder "...+01:00"
      const hasTZ = s.endsWith('Z') || /[+-]\d\d:\d\d$/.test(s)
      if (!hasTZ) s += 'Z'

      const d = new Date(s)
      if (isNaN(d.getTime())) return ts

      return d.toLocaleString(undefined, {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      })
    }
  }))
})
</script>
{% endblock %}

{% block content %}
<div x-data="ticketsManager()" class="space-y-6 max-w-7xl mx-auto">

  <!-- HEADER -->
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold">Ticket-√úbersicht</h1>

    <button
      @click="deleteSelected"
      :disabled="selected.length === 0"
      class="px-4 py-2 rounded-md bg-red-600 text-white
             disabled:opacity-40 disabled:cursor-not-allowed">
      üóëÔ∏è L√∂schen (<span x-text="selected.length"></span>)
    </button>
  </div>

  <!-- FILTER -->
  <div class="flex flex-wrap items-center gap-3">
    <template x-for="s in statuses" :key="s">
      <button
        @click="filter = s"
        class="px-3 py-1.5 rounded-md text-sm font-medium capitalize"
        :class="filter === s
          ? 'bg-primary text-white'
          : 'bg-white border hover:bg-primary/10'">
        <span x-text="s"></span>
      </button>
    </template>

    <div class="ml-auto">
      <input
        type="text"
        x-model="search"
        placeholder="Suchen‚Ä¶"
        class="px-3 py-2 border rounded-md w-64">
    </div>
  </div>

  <!-- TABLE -->
  <div class="bg-white border rounded-xl shadow overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-gray-100 text-gray-600">
        <tr>
          <th class="p-4 w-10 text-center">
            <input type="checkbox" @change="toggleAll">
          </th>
          <th class="p-4 text-left">ID</th>
          <th class="p-4 text-left">Titel</th>
          <th class="p-4 text-left">Ersteller</th>
          <th class="p-4 text-left">Status</th>
          <th class="p-4 text-left">Priorit√§t</th>
          <th class="p-4 text-right">Aktion</th>
        </tr>
      </thead>

      <tbody class="divide-y">
        <template x-for="t in filtered" :key="t.id">
          <tr class="hover:bg-gray-50">

            <td class="p-4 text-center">
              <input
                type="checkbox"
                :checked="selected.includes(t.id)"
                @change="toggle(t.id)">
            </td>

            <td class="p-4 font-mono text-primary">
              #<span x-text="t.id"></span>
            </td>

            <td class="p-4">
              <div class="font-medium" x-text="t.title"></div>

              <!-- ‚úÖ sch√∂ner Timestamp + Tooltip mit Raw ISO -->
              <div class="text-xs text-gray-500"
                   :title="t.created_at"
                   x-text="formatLocal(t.created_at)">
              </div>
            </td>

            <td class="p-4" x-text="t.creator"></td>

            <td class="p-4">
              <span
                class="px-2 py-1 rounded text-xs font-semibold"
                :class="statusClass(t.status)"
                x-text="t.status">
              </span>
            </td>

            <td class="p-4">
              <span
                class="px-2 py-1 rounded text-xs font-semibold"
                :class="priorityClass(t.priority)"
                x-text="t.priority">
              </span>
            </td>

            <td class="p-4 text-right">
              <a
                :href="`/ticket-overview/${t.id}`"
                class="px-3 py-1.5 rounded bg-primary/10 text-primary hover:bg-primary/20">
                Details ‚Üí
              </a>
            </td>

          </tr>
        </template>

        <template x-if="filtered.length === 0">
          <tr>
            <td colspan="7" class="p-8 text-center text-gray-500">
              Keine Tickets gefunden
            </td>
          </tr>
        </template>

      </tbody>
    </table>
  </div>

</div>
{% endblock %}
