{% extends "base.html" %}
{% block title %}Ticket #{{ ticket.id }} ‚Äì Detail{% endblock %}

{% block content %}

{# ================================================= #}
{# JSON RENDER MACROS (ROBUST & DYNAMIC)              #}
{# ================================================= #}

{% macro labelize(s) -%}
  {{ (s|string).replace("_", " ").replace("-", " ")|capitalize }}
{%- endmacro %}

{% macro render_scalar(v) -%}
  {% if v is sameas true %}
    <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200 font-semibold">Ja</span>
  {% elif v is sameas false %}
    <span class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-200 font-semibold">Nein</span>
  {% elif v is number %}
    <span class="font-medium text-gray-900 dark:text-gray-100">{{ v }}</span>
  {% else %}
    {% set s = v|string %}
    {% if s|length == 36 and s.count('-') == 4 %}
      <span class="font-mono text-xs bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded px-2 py-1 break-all text-gray-800 dark:text-gray-100">{{ s }}</span>
    {% elif s|length == 10 and s[4] == '-' and s[7] == '-' %}
      <span class="font-mono text-sm bg-gray-100 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded px-2 py-1 text-gray-800 dark:text-gray-100">{{ s }}</span>
    {% elif '\n' in s or s|length > 120 %}
      <div class="whitespace-pre-wrap text-sm bg-gray-50 dark:bg-gray-900/30 border border-gray-200 dark:border-gray-700 rounded-lg p-3 max-h-64 overflow-auto text-gray-800 dark:text-gray-100">
        {{ s }}
      </div>
    {% else %}
      <span class="text-sm font-medium break-words text-gray-900 dark:text-gray-100">{{ s }}</span>
    {% endif %}
  {% endif %}
{%- endmacro %}

{% macro render_any(value) -%}
  {% if value is mapping %}
    {{ render_mapping(value) }}
  {% elif value is sequence and value is not string %}
    {{ render_list(value) }}
  {% else %}
    {{ render_scalar(value) }}
  {% endif %}
{%- endmacro %}

{% macro render_mapping(m) -%}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    {% for k, v in m.items() %}
      {% if v is none or v == "" or (v is mapping and v|length == 0) or (v is sequence and v is not string and v|length == 0) %}
      {% else %}
        {% if v is mapping or (v is sequence and v is not string) %}
          <div class="md:col-span-2 border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 overflow-hidden">
            <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/60 flex justify-between">
              <div class="text-xs font-semibold uppercase text-gray-600 dark:text-gray-300">
                {{ labelize(k) }}
              </div>
            </div>
            <div class="p-4">
              {{ render_any(v) }}
            </div>
          </div>
        {% else %}
          <div class="border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 p-3">
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">{{ labelize(k) }}</div>
            {{ render_scalar(v) }}
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
{%- endmacro %}

{% macro render_list(seq) -%}
  <div class="space-y-3">
    {% for item in seq %}
      <div class="border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 p-4">
        {{ render_any(item) }}
      </div>
    {% endfor %}
  </div>
{%- endmacro %}

<div class="max-w-7xl mx-auto p-8 space-y-8">

  <!-- HEADER -->
  <div class="flex items-center justify-between">
    <div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Ticket #{{ ticket.id }}</div>
      <h1 class="text-2xl font-semibold mt-1 text-gray-800 dark:text-gray-100">{{ ticket.title }}</h1>
    </div>

    <a href="/ticket-overview"
       class="px-4 py-2 rounded-md
              bg-gray-200 hover:bg-gray-300
              dark:bg-gray-800 dark:hover:bg-gray-700
              text-gray-800 dark:text-gray-100
              border border-gray-200 dark:border-gray-700">
      ‚Üê Zur √úbersicht
    </a>
  </div>

  <!-- MAIN GRID -->
  <div class="grid grid-cols-1 xl:grid-cols-[360px_1fr] gap-6">

    <!-- LEFT: META -->
    <aside class="space-y-6">

      <!-- Overview -->
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow p-5 text-sm space-y-3">
        <h2 class="font-semibold text-lg mb-2 text-gray-800 dark:text-gray-100">√úbersicht</h2>

        <div>
          <span class="text-gray-500 dark:text-gray-400">Status</span>
          <div class="font-medium text-gray-800 dark:text-gray-100">{{ ticket.status.value }}</div>
        </div>

        <div>
          <span class="text-gray-500 dark:text-gray-400">Priorit√§t</span>
          <div class="font-medium capitalize text-gray-800 dark:text-gray-100">{{ ticket.priority.value }}</div>
        </div>

        <div>
          <span class="text-gray-500 dark:text-gray-400">Erstellt</span>
          <div class="font-medium js-time text-gray-800 dark:text-gray-100"
               data-ts="{{ ticket.created_at.isoformat() }}"></div>
        </div>

        {% if ticket.updated_at %}
        <div>
          <span class="text-gray-500 dark:text-gray-400">Zuletzt ge√§ndert</span>
          <div class="font-medium js-time text-gray-800 dark:text-gray-100"
               data-ts="{{ ticket.updated_at.isoformat() }}"></div>
        </div>
        {% endif %}
      </div>

      <!-- Owner -->
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow p-5 text-sm">
        <h3 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Antragsteller</h3>
        <div class="font-medium text-gray-800 dark:text-gray-100">{{ ticket.owner_name }}</div>
      </div>

      <!-- Workflow -->
      {% if ticket.workflow_state_parsed and ticket.workflow_state_parsed.departments %}
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow p-5 text-sm">
        <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">Fachabteilungen</h3>

        <ul class="space-y-2">
          {% for _, dept in ticket.workflow_state_parsed.departments.items() %}
          <li class="flex justify-between items-center border border-gray-200 dark:border-gray-700 rounded px-3 py-2
                     bg-white dark:bg-gray-800">
            <span class="text-gray-800 dark:text-gray-100">{{ dept.name }}</span>
            <span class="text-xs px-2 py-1 rounded
              {% if dept.status == 'done' %}
                bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200
              {% elif dept.status == 'open' %}
                bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200
              {% else %}
                bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300
              {% endif %}">
              {{ dept.status }}
            </span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </aside>

    <!-- RIGHT: CONTENT -->
    <section class="grid grid-cols-1 xl:grid-cols-[1fr_420px] gap-6 items-start">

      <!-- AUFTRAGSINHALT -->
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow p-6 space-y-4">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Auftragsinhalt</h2>

        {% if description and description is mapping %}
          {% for section, data in description.items() %}
            <details class="border border-gray-200 dark:border-gray-700 rounded-xl bg-gray-50 dark:bg-gray-700/40 overflow-hidden">
              <summary class="cursor-pointer px-4 py-3 font-semibold text-gray-800 dark:text-gray-100">
                {{ labelize(section) }}
              </summary>
              <div class="p-4">
                {{ render_any(data) }}
              </div>
            </details>
          {% endfor %}
        {% else %}
          <div class="text-sm text-gray-500 dark:text-gray-400 italic">
            Keine Auftragsdaten vorhanden.
          </div>
        {% endif %}
      </div>

      <!-- VERLAUF -->
      <aside class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow p-6 xl:sticky xl:top-8 max-h-[80vh] overflow-auto">
        <h2 class="text-lg font-semibold mb-6 text-gray-800 dark:text-gray-100">Verlauf</h2>

        {% if history and history|length > 0 %}
        <ol class="relative border-l border-gray-300 dark:border-gray-700 pl-6 space-y-8">

          {% for e in history %}
            {# --- normalize event shape (dict OR object) --- #}
            {% if e is mapping %}
              {% set action = e.get("action") %}
              {% set actor = e.get("actor", {}) %}
              {% set details = e.get("details", {}) %}
              {% set ts = e.get("timestamp") %}
            {% else %}
              {% set action = e.action %}
              {% set actor = e.actor %}
              {% set details = e.details %}
              {% set ts = e.timestamp %}
            {% endif %}

            {# --- normalize actor fields --- #}
            {% if actor is mapping %}
              {% set actor_name = actor.get("name") or "System" %}
              {% set actor_id = actor.get("id") %}
              {% set actor_type = actor.get("type") %}
            {% else %}
              {% set actor_name = (actor.name if actor is not none and actor.name is defined else (actor or "System")) %}
              {% set actor_id = (actor.id if actor is not none and actor.id is defined else none) %}
              {% set actor_type = (actor.type if actor is not none and actor.type is defined else none) %}
            {% endif %}

            {# --- normalize department name (optional) --- #}
            {% if details is mapping %}
              {% set dept_name = details.get("department_name") %}
            {% else %}
              {% set dept_name = (details.department_name if details is not none and details.department_name is defined else none) %}
            {% endif %}

          <li class="relative group">
            <span class="absolute -left-[11px] top-1 w-5 h-5 rounded-full bg-primary"></span>

            <div class="bg-gray-50 dark:bg-gray-700/40 rounded-lg p-4
                        hover:bg-gray-100 dark:hover:bg-gray-700 transition">

              <div class="flex justify-between items-start gap-4">
                <div class="font-medium text-sm text-gray-800 dark:text-gray-100">
                  {% if action == "ticket_created" %}
                    üìù Ticket erstellt
                  {% elif action == "ticket_updated" %}
                    ‚úèÔ∏è Ticket bearbeitet
                  {% elif action == "ticket_submitted" %}
                    üì§ An Fachabteilungen √ºbergeben
                  {% elif action == "department_done" %}
                    ‚úÖ Fachabteilung erledigt{% if dept_name %} ‚Äì {{ dept_name }}{% endif %}
                  {% elif action == "ticket_archived" %}
                    üì¶ Ticket archiviert
                  {% else %}
                    ‚ÑπÔ∏è {{ action }}
                  {% endif %}
                </div>

                <div class="text-xs text-gray-500 dark:text-gray-300 whitespace-nowrap">
                  {{ actor_name }}
                </div>
              </div>

              <div class="text-xs text-gray-400 dark:text-gray-400 mt-1 js-time"
                   data-ts="{{ ts }}"></div>


            </div>
          </li>
          {% endfor %}
        </ol>
        {% else %}
          <div class="text-sm text-gray-500 dark:text-gray-400 italic">
            Kein Verlauf vorhanden.
          </div>
        {% endif %}
      </aside>

    </section>
  </div>
</div>

<script>
document.querySelectorAll('.js-time').forEach(el => {
  let ts = el.dataset.ts;
  if (!ts) return;

  if (ts.includes(' ') && !ts.includes('T')) {
    ts = ts.replace(' ', 'T');
  }
  if (!ts.endsWith('Z') && !ts.match(/[+-]\d\d:\d\d$/)) {
    ts += 'Z';
  }

  const d = new Date(ts);
  el.textContent = isNaN(d) ? ts : d.toLocaleString();
});
</script>

{% endblock %}
